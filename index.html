<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Gestions üîê</title>
<style>
  
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  text-align: center;
  margin: 0;
  padding: 0;
  background-color: white;
}
  
.container {  
  transition: all 0.3s ease; 
  display: flex;
  flex-direction: column;
  align-items: center;
}
  
input, button, textarea {
  display: block;
  padding: 12px;
  margin: 8px 0;
  border-radius: 6px;
  border: 1px solid #bbb;
  font-size: 16px;
  align-items: center;
  width: 90%;
  box-sizing: border-box;
}
  
input:focus, textarea:focus {
  border-color: #007bff;
  outline: none;
}
  
button {
  background-color: #008CBA;
  color: white;
  padding: 10px 20px;
  border: none;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s ease;
  border-radius: 8px;
  box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.2);
  width: auto;
}
  
button:hover {
  background-color: #005A9C;
  transform: scale(1.05);
  box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.3);
}
  
button:active {
  transform: scale(0.95);
}
  
a {
  text-decoration: none;
  font-weight: bold;
  color: #3366cc;
  transition: all 0.3s ease;
}
  
a:hover {
  color: #ff6600;
  font-weight: bold;
  text-shadow: 0 0 25px rgba(255, 102, 0, 0.6);
  animation: pulseGlow 1.5s infinite;
  text-decoration: underline;
}
  
a.active {
  color: red;
  text-shadow: 0 0 25px rgba(255, 0, 0, 0.6);
}
  
@keyframes pulseGlow {
  0%   { text-shadow: 0 0 5px rgba(255, 102, 0, 0.3); }
  50%  { text-shadow: 0 0 15px rgba(255, 102, 0, 0.6); }
  100% { text-shadow: 0 0 5px rgba(255, 102, 0, 0.3); }
}
  
.hidden { display: none; }
  
.separator {
  height: 2px;
  background-color: #ccc;
  width: 90%;
  margin: 16px auto;
}
  
.account {
  border: 1px solid #ddd;
  padding: 12px;
  margin: 10px 0;
  text-align: left;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
}
  
.account img {
  max-width: 90%;
  border-radius: 4px;
  margin-top: 10px;
}
  
.account a {
  color: #007bff;
  text-decoration: underline;
}
  
.account a:hover {
  text-decoration: none;
}
  
.actions {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 10px;
}
  
#image-preview {
  margin-top: 10px;
  display: none;
  max-width: 95%;
  height: auto;
  border: 1px solid #ccc;
  border-radius: 5px;
  display: block;             
  margin-left: auto;          
  margin-right: auto;
}
  
#form-wrapper {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
}
  
#form-wrapper.active {
  max-height: 5000px; 
}
  
#form-container {
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  padding: 20px;
  background-color: #fff;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  max-width: 500px;
  margin: 20px auto;
}
  
#account-form input,
#account-form textarea,
#account-form button {
  margin: 8px 0;
  width: 90%;
}
  
#app-container {
  max-width: 100%;
  margin: 0 auto;
  padding: 20px;
}
  
@media screen and (max-width: 768px) {
  #app-container {
    padding: 10px;
  }
  
input, button, textarea {
    max-width: 100%;
  }
}
  
#menuContainer {
  position: fixed;  
  top: 3px;        
  right: 15px; 
  z-index: 1000;
  cursor: pointer;
}
  
#inactivity-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  
#inactivity-modal.hidden {
  display: none;
}
  
#password-requirements {
  text-align: left;        
  list-style: none;     
  margin: 6px 0;
  padding-left: 12px;     
  width: 50%;        
}
  
#alert-modal {
  position: fixed;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  background: transparent
}
  
#alert-modal.hidden {
  display: none;
}
  
#alert-modal .modal-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
  font-size: 18px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
}
  
.accounts-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 10px;
  justify-content: center;      
  align-items: start;
  margin: 10px auto;              
  width: 100%;
}
  
.account {
  flex: 0 0 auto;
}
  
.button-group {
  display: flex;
  flex-wrap: wrap; 
  justify-content: center; 
  gap: 15px; 
}
  
.button-group button {
  width: auto; 
  padding: 8px 16px;
  font-size: 16px;
  cursor: pointer;
}
  
.modal-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
  font-size: 18px;
}
  
.imgcrtl img {
  max-width: 95%;
  height: auto;
  width:auto
}
  
.imgcrtl {
  display: flex;
  justify-content: center;
  align-items: center;
}
  
.menu-container {
  position: relative;
  display: inline-block;
}
  
.menu-button {
  padding: 10px 20px;
  background-color: #4285f4;
  color: white;
  border: none;
  cursor: pointer;
  font-size: 16px;
}
  
.menu-items {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: none;
  flex-direction: column;
  background-color: #ffffff;
  border-radius: 8px;
  border: 1px solid #ccc;
  z-index: 100;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
  opacity: 0;
  transition: opacity 0.3s ease, transform 0.3s ease;
  overflow: hidden;
  width: auto;
  padding: 24px;
  max-width: 90vw;
  box-sizing: border-box;
  gap: 10px;
}
  
.menu-items.show {
  display: flex;
  opacity: 1;
}
  
.menu-items button {
  padding: 12px 20px;
  background-color: transparent;
  border: none;
  font-size: 15px;
  color: #333;
  text-align: left;
  cursor: pointer;
  white-space: nowrap;
  transition: background-color 0.2s ease, color 0.2s ease;
  margin: 0;
  width: 100%;
  line-height: 2; 
}
  
.menu-items button:hover {
  background-color: #f5f5f5;
  color: #000;
}
  
.loader-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: white;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  scrollbar: none;
}
  
.loader {
  width: 120px;
  height: 120px;
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 50%;
  background: linear-gradient(0deg, #FFFFFF 50%, #005A9C 100%);
  animation: spin 1s linear infinite;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
}
  
.inner-circle {
  width: 90%;
  height: 90%;
  background-color: white;
  border-radius: 50%;
  box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
}
  
.loader-text {
  margin-top: 20px;
  font-size: 1.2em;
  font-weight: bold;
  color: #005A9C;
  font-family: sans-serif;
  text-align: center;
  transition: all 0.3s ease-in-out;
}
  
@keyframes spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}
  
@media (max-width: 599px) {
.responsive-width {
  width: 90%; 
}}
  
@media (min-width: 600px) and (max-width: 1024px) {
    .responsive-width {
  width: 70%; 
}}
  
@media (min-width: 1025px) {
 .responsive-width {
  width: 30%;
}}
  
.countdown-container {
  text-align: center;
  color: #f0f0f0;
  font-family: 'Segoe UI', sans-serif;
  background-color: #0a0a1a;
  padding: 20px;
  border-radius: 12px;
}
  
.countdown-title {
  font-size: 24px;
  margin-bottom: 20px;
  color: #ffffff;
}
  
.countdown-circles {
  display: flex;
  justify-content: center;
  gap: 30px;
}
  
.circle {
  position: relative;
  width: 100px;
  height: 100px;
}
  
.circle-label {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}
  
.circle-label span {
  font-size: 24px;
  font-weight: bold;
  display: block;
  color: #ffffff;
}
  
.circle-label p {
  font-size: 12px;
  margin: 0;
  color: #cccccc;
}
  
#progress-hours,
#progress-minutes,
#progress-seconds {
  stroke-dasharray: 282.6;
  stroke-dashoffset: 0;
  transition: stroke-dashoffset 1s linear;
}
  
#search {
  padding: 12px 16px;
  font-size: 18px;
  border: 2px solid #007BFF;
  border-radius: 8px;
  box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
}
  
#search:focus {
  border-color: #005A9C;
  box-shadow: 0 0 10px rgba(0, 90, 156, 0.3);
  outline: none;
}
  
.modal {
  position: fixed;
  top: 0;
  left: 0;
  inset: 0;
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 20000;
  background: rgba(0,0,0,0.45);
  padding: 20px;
  box-sizing: border-box;
}
  
.modal .modal-content {
  position: relative;
  z-index: 20001;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.35);
  max-width: 90vw;
  width: 720px;
  max-height: 85vh;
  overflow: auto;
  padding: 18px;
  box-sizing: border-box;
}
  
.modal.small .modal-content {
  width: min(520px, 95vw);
  max-height: 80vh;
}
  
.dynamic-alert {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 21000;
}
  
#historiqueConnexionModal .modal-content table {
  width: 100%;
  border-collapse: collapse;
}
  
#historiqueConnexionModal .modal-content th,
#historiqueConnexionModal .modal-content td {
  border: 1px solid #ddd;
  padding: 8px;
  font-size: 14px;
  vertical-align: top;
}

@media (max-width: 480px) {
  #historiqueConnexionModal .modal-content { padding: 12px; font-size: 13px; }
  #historiqueConnexionModal .modal-content th, #historiqueConnexionModal .modal-content td { padding: 6px; }
}
  
.modal-buttons {
  margin-top: 20px;
  display: flex;
  justify-content: space-around;
}
  
@media (max-width: 480px) {
  #historiqueConnexionModal .modal-content { width: 100%; padding: 12px; font-size: 13px; }
  #historiqueConnexionModal .modal-content th, #historiqueConnexionModal .modal-content td { padding: 6px; }
}

#nipUpdateModal .modal-content,
#updateAccountModal .modal-content {
  margin: 0 auto;           
  display: flex;
  flex-direction: column;
  align-items: center;  
  justify-content: center; 
  text-align: center; 
}
#nipUpdateModal .modal-content input,
#updateAccountModal .modal-content input {
  width: 80%;  
  margin: 6px auto;
}
  
#nipUpdateModal .modal-buttons,
#updateAccountModal .modal-buttons {
  justify-content: center; 
  gap: 10px;
}


#historiqueConnexionModal .modal-buttons {
  justify-content: center; 
}

#form-wrapper {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
}
  
#form-wrapper.active {
  max-height: 5000px;
}

  #form-wrapper.active {
  display: block;
}

.calendar {
  display:flex;
  flex-direction:column;
  gap:12px;
  align-items:center;
  width:100%;
}
  
.calendar-controls {
  display:flex;
  gap:8px;
  align-items:center;
  justify-content:center;
  width:100%;
}
  
.calendar-grid {
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  gap:6px;
  width:100%;
  max-width:520px;
}
  
.calendar-day {
  padding:8px 6px;
  text-align:center;
  border-radius:6px;
  background:#f5f7fb;
  color:#333;
  cursor:default;
  font-size:14px;
  user-select:none;
  border:1px solid transparent;
}
  
.calendar-day.disabled {
  opacity:0.35;
  filter:grayscale(30%);
}
  
.calendar-day.available {
  background:linear-gradient(180deg,#e8f7ff,#d7efff);
  cursor:pointer;
  border:1px solid #28a0ff;
  box-shadow: 0 2px 6px rgba(40,160,255,0.12);
}
  
.calendar-day.selected {
  background:#007bff;
  color:#fff;
  border-color:#005ab8;
  box-shadow: 0 6px 18px rgba(0,90,156,0.18);
}
  
.calendar-weekday {
  font-weight:600;
  font-size:12px;
  color:#666;
  text-align:center;
}
  
.calendar-month-title {
  font-weight:700;
  font-size:16px;
  color:#222;
}
  
.calendar-nav-btn {
  padding:6px 10px;
  border-radius:6px;
  border:1px solid #ddd;
  background:#fff;
  cursor:pointer;
}


  
</style>
</head>
<body>

  
<!-- Connexion -->
<div class="container" id="login-container">
  <h1 style="font-size:40px; color: #333;">üõ°Ô∏è Acc√®s s√©curis√©</h1>
  <div class="separator"></div><br/><br/><br/><br/>
  
  <h2 style="color: #333;">üîê Ouvrir une session</h2>
  <form class="container" id="login-form" style="width: 100%">
    <input autocomplete="off" class="responsive-width" id="login-username" placeholder="Nom d'utilisateur" style="margin: 2px 0 2px" type="text"/>
    <input autocomplete="off" class="responsive-width" id="login-password" placeholder="Mot de passe" type="password"/>
    <p class="responsive-width" style="font-size: 15px; display: flex; justify-content: flex-start; margin: 5px 0 0 0; font-weight: none; font-style: italic;">
      <a href="#" onclick="showRecovery()">Identifiant ou mot de passe oubli√© ?</a>
    </p><br/>
    <button class="responsive-width" onclick="login()" type="button">Se connecter</button>
  </form><br/><br/>
  <!-- √Ä placer sous le bouton "Se connecter" -->
<button id="bioFacLoginBtn" class="responsive-width hidden" onclick="tryBioFacLogin()">üîê Connexion bio/fac</button>

  <br/><br/><br/>
  <p>Pas de compte ?
    <a href="#" onclick="showRegister()" style="margin: 0 10px 0 10px">Cr√©e un compte</a> 
    ou  üì• 
    <a href="#" onclick="importEncryptedVault()" style="margin: 0 0 0 5px">Importer</a>
  </p>
</div>

  
<!-- Modifier ID -->
<div class="container hidden" id="recovery-container">
  <h1 style="font-size:40px; color: #333;">üõ°Ô∏è Acc√®s s√©curis√©</h1>
  <div class="separator"></div><br/><br/><br/>
  
  <h2 style="color: #333;">üìù Modifier un ID</h2>
  <form class="container" style="width: 100%">
    <select autocomplete="off" class="responsive-width" id="recovery-type" style="padding: 12px 16px;font-size: 16px;border: 2px solid #007BFF;color: #333;box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.1); margin: 0 0 5px">
      <option value=""> ‚Äî Select ID a modifier ‚Äî </option>
      <option value="username">Nom d'utilisateur oubli√©</option>
      <option value="password">Mot de passe oubli√©</option>
    </select>
    <input autocomplete="off" class="responsive-width" id="recovery-known" placeholder="Entrez l'information connue" style="margin: 2px 0 2px" type="text"/>
    <input autocomplete="off" class="responsive-width" id="recovery-mastercode" placeholder="NIP" type="password"/><br/>
    <button class="responsive-width" onclick="recoverIdentity()" type="button">Valider</button>
  </form><br/><br/><br/><br/><br/>
  <p><a href="#" onclick="showLogin()">Retour √† la connexion</a></p>
</div>

  
<!-- Inscription -->
<div class="container hidden" id="register-container">
  <h1 style="font-size:45px; color: #333;">üõ°Ô∏è Acc√®s s√©curis√©</h1>
  <div class="separator"></div><br/><br/><br/>
  <div style="display: bloc;justify-content: center; align-items: center; width:100%  ">
    <h2 style="color: #333;">üßë‚Äçüíª Cr√©e un compte</h2>
    <form class="container" id="register-form" style="width: 100%">
      <input autocomplete="off" class="responsive-width" id="register-fullname" placeholder="Nom du d√©tenteur du compte" type="text"/>
      <input autocomplete="off" class="responsive-width" id="register-username" placeholder="Nom d'utilisateur" style="margin: 2px 0 2px" type="text"/>
      <input autocomplete="off" class="responsive-width" id="register-password" placeholder="Mot de passe" type="password"/>
      <span onclick="checklist_mp('password-requirements-container1')" style="cursor: pointer; color: gray; font-style: italic; display: inline-block; margin-left: 0;">
        üí°<u>Checklist du mot de passe</u></span>
      <div id="password-requirements-container1" style="display: none;">
        <ul id="password-requirements1" style="margin: 2px 0 2px 25px; text-align: left; font-size: 14px; list-style: none; padding-left: 0;">
          <li id="req-length-register">‚ùå Au moins 8 caract√®res</li>
          <li id="req-digit-register">‚ùå Inclure un chiffre</li>
          <li id="req-special-register">‚ùå Inclure un caract√®re sp√©cial (Ex: .!@#$%^&amp;*(),?:{}|&lt;&gt;)</li>
          <li id="req-lowercase-register">‚ùå Inclure une lettre minuscule</li>
          <li id="req-uppercase-register">‚ùå Inclure une lettre majuscule</li>
        </ul>
      </div>
      <input autocomplete="off" class="responsive-width" id="nip" maxlength="10" name="nip" pattern="^[^\s]{4,10}$" placeholder="NIP (facultatif)" type="text"/>
      <input autocomplete="off" class="responsive-width" id="register-mastercode" placeholder="Code unique" type="password"/><br/>
      <button class="responsive-width" onclick="register()" style="display: block; margin: 0 auto; ">Valider</button>
    </form><br/><br/><br/><br/><br/>
    <p><a href="#" onclick="showLogin()">Retour √† la connexion</a></p>
  </div>
</div>

  
<!-- App -->
<div class="container hidden" id="app-container" style="top:0">
  <h1 style="position: fixed; top: 0; z-index: 1000; width: 100%; padding-left: 10px;        
    text-align: left; font-size: 25px; color: #333; margin-top: 0; background-color: #ffffff;">
    <div style="height: 15px;"></div>        
    üõ°Ô∏è Acc√®s s√©curis√©        
    <div class="separator"></div>
  </h1><br/><br/><br/><br/>
  
  <!-- Barre de recherche -->
  <div style="display: flex; justify-content: center; align-items: center; gap: 10px; width:100%">
    <span style="font-size:30px;  margin-left: -20px;">üîç</span>
    <input autocomplete="off" id="search" oninput="renderAccounts()" placeholder="Rechercher un compte..." style="width: 50%;  margin-left: -8px;" type="text"/>
  </div><br/>
  <div id="login-info" style="margin: 10px; font-style: italic; color: #555;"></div>
  
  <!-- Nombre de compte -->
  <div id="account-count" style="position: fixed; top: 11px;            
    right: 120px; width:auto; z-index: 1000; font-size: 16px; cursor: pointer;      
    min-width: auto; background-color: #007bff;color: white;padding: 10px 15px;     
    border-radius: 20px;font-size: 18px;font-weight: bold;display: inline-block; text-align: center;">0   
  </div>
  
  <!-- Apk save -->
  <div class="accounts-container" id="accounts-list"></div>
  
  <!-- Menu -->
  <div class="menu-container" id="menuContainer">
    <button class="menu-button" id="menu-toggle">‚ò∞ Menu</button>
    <div class="menu-items" id="menuItems">     
      <div id="greeting-message" style="font-weight: bold; font-size: 18px; color: #333; text-align: center;"></div> 
      <button id="menu-add-account" onclick="openAccountModal(false)" style="width: auto; white-space: nowrap;">üìù Ajouter un compte</button>
      <button onclick="verifierExpiration()" style="width: auto; white-space: nowrap;">üìÖ Gestions de suivi</button>
      <button onclick="afficherDerniereConnexion()" style="width: auto; white-space: nowrap;">‚öôÔ∏è Param√®tre de connexion</button>
      <button id="top-right-button" onclick="logout()" style="width: auto; white-space: nowrap;">üîí D√©connexion</button>    
    <br><br><!-- √Ä placer en bas du menuItems -->
<button id="bioFacToggleBtn" class="hidden" onclick="toggleBioFac()">‚öôÔ∏è Activer bio/fac</button>

    </div>  
  </div>
</div>


<!-- Historique de connxion -->
<div class="modal hidden" id="historiqueConnexionModal">
  <div class="modal-content">
    <h3>üìú Historique de connexion</h3>
    <label>Choisir une date :</label>
    <div id="calendar-container" style="margin-top:8px;"></div>
    <div id="periode-affichee" style="margin-top:8px; font-style: italic; color: #555;"></div>
    <div id="historique-connexion-content" style="text-align:left; font-size:15px;"></div>
    <div class="modal-buttons">
      <button onclick="confirmerSuppressionHistorique()">üóëÔ∏è Supprimer</button>
      <button onclick="fermerHistoriqueConnexion()">Fermer</button>
    </div>
  </div>
</div>

  
<!-- Decompte -->
<div class="hidden" id="inactivity-modal">
  <div class="countdown-container">
    <h2 class="countdown-title">D√âCONNEXION DANS ‚åõ</h2>
    <div class="countdown-circles">
      <div class="circle" id="circle-hours">
        <svg height="100" width="100">
          <circle cx="50" cy="50" fill="none" r="45" stroke="#333" stroke-width="8"></circle>
          <circle cx="50" cy="50" fill="none" id="progress-hours" r="45" stroke="#00ffcc" stroke-linecap="round" stroke-width="8" transform="rotate(-90 50 50)"></circle>
        </svg>
        <div class="circle-label">
          <span id="hours-value">00</span><p>HEURES</p>
        </div>
      </div>
      <div class="circle" id="circle-minutes">
        <svg height="100" width="100">
          <circle cx="50" cy="50" fill="none" r="45" stroke="#333" stroke-width="8"></circle>
          <circle cx="50" cy="50" fill="none" id="progress-minutes" r="45" stroke="#00ffcc" stroke-linecap="round" stroke-width="8" transform="rotate(-90 50 50)"></circle>
        </svg>
        <div class="circle-label">
          <span id="minutes-value">00</span><p>MINUTES</p>
        </div>
      </div>
      <div class="circle" id="circle-seconds">
        <svg height="100" width="100">
          <circle cx="50" cy="50" fill="none" r="45" stroke="#333" stroke-width="8"></circle>
          <circle cx="50" cy="50" fill="none" id="progress-seconds" r="45" stroke="#00ffcc" stroke-linecap="round" stroke-width="8" transform="rotate(-90 50 50)"></circle>
        </svg>
        <div class="circle-label">
          <span id="seconds-value">00</span><p>SECONDES</p>
        </div>
      </div>  
    </div>  
    <p><u style="font-size: 14px;text-decoration:none">          
      üí° Cliquer sur l'ecran pour l'arreter!</u></p>
  </div>
</div>

  
<!-- Alert -->
<div class="hidden" id="alert-modal">
  <div class="modal-content" id="alert-message"></div>
</div>
  
<div class="loader-container" id="loader" style="display: none;">
  <div class="loader"><div class="inner-circle"></div></div>
  <div class="loader-text" id="loader-text">üì• Chargement en cours...</div>
</div>

  
<!-- Fen√™tres modales -->
<div class="modal" id="nipModal" style="display: none;">
  <div class="modal-content">
    <h3>Cr√©er votre NIP</h3>
    <input id="nipInput" maxlength="10" placeholder="4 √† 10 caract√®res, sans espace" type="text"/>
    <div class="modal-buttons">
      <button onclick="validateNipModal()">Valider</button>
      <button onclick="closeNipModal()">Annuler</button>
    </div>
  </div>
</div>


<!-- Modifier ID -->
<div class="modal hidden" id="updateAccountModal">
  <div class="modal-content">
    <h3>‚öôÔ∏è Modifier mon compte</h3>
    <input id="update-new-username" placeholder="Nouveau nom d'utilisateur" type="text"/>
    <input id="update-new-password" placeholder="Nouveau mot de passe" type="password"/>
    <div style="text-align:left; margin-top:8px;">
      <span onclick="checklist_mp('password-requirements-update-modal')" style="cursor:pointer; color:gray; font-style:italic;">üí° Checklist du mot de passe</span>
      <div id="password-requirements-update-modal" style="display:none; margin-top:6px;">
        <ul style="list-style:none; padding-left:0; font-size:14px;">
        <li id="req-length-modal">‚ùå Au moins 8 caract√®res</li>
        <li id="req-digit-modal">‚ùå Inclure un chiffre</li>
        <li id="req-special-modal">‚ùå Inclure un caract√®re sp√©cial</li>
        <li id="req-lowercase-modal">‚ùå Inclure une lettre minuscule</li>
        <li id="req-uppercase-modal">‚ùå Inclure une lettre majuscule</li>
        </ul>
      </div>
    </div>
    <input id="update-nip" placeholder="NIP (validation requise)" type="password"/>
    <div class="modal-buttons" style="margin-top:14px;">
      <button onclick="submitUpdateAccount()">Valider</button>
      <button onclick="closeUpdateAccountModal()">Annuler</button>
    </div>
  </div>
</div>


<!-- Reset -->
<div class="modal hidden" id="nipConfirmModal">
  <div class="modal-content">
    <h3>Entrez votre NIP pour confirmer la r√©initialisation</h3>
    <input id="nipConfirmInput" maxlength="10" placeholder="Votre NIP" type="password"/>
    <div class="modal-buttons">
      <button onclick="validerReinitialisation()">Valider</button>
      <button onclick="fermerModalReinitialisation()">Annuler</button>
    </div>
  </div>
</div>


<!-- Cree NAME -->
<div class="modal hidden" id="fullnameModal">
  <div class="modal-content">
    <h3>Ajouter votre nom complet</h3>
    <input id="fullnameInput" placeholder="Nom complet (min. 4 lettres)" type="text"/>
    <div class="modal-buttons">
      <button onclick="validateFullname()">Valider</button>
      <button onclick="closeFullnameModal()">Annuler</button>
    </div>
  </div>
</div>


<!-- Mod NIP -->
<div class="modal hidden" id="nipUpdateModal">
  <div class="modal-content">
    <h3>Modifier votre NIP</h3>
    <input id="oldNipInput" placeholder="Ancien NIP" type="password"/>
    <input id="newNipInput" placeholder="Nouveau NIP (min. 4 chiffres)" type="password"/>
    <div class="modal-buttons">
      <button onclick="updateNip()">Valider</button>
      <button onclick="closeNipUpdateModal()">Annuler</button>
    </div>
  </div>
</div>


<!-- Ajout d'un compte -->
<div class="modal hidden" id="accountModal">
  <div class="modal-content" style="width: min(720px, 95vw); max-height: 85vh; overflow-y: auto;">
    <h3 id="accountModalTitle">üìù Ajouter un compte</h3>
    <form id="account-form" style="display: flex; flex-direction: column; align-items: center; width:100%">
      <input id="account-name" placeholder="Nom du compte" type="text" required />
      <input id="account-user" placeholder="Nom d'utilisateur" type="text" />
      <div style="display: flex; justify-content: center; gap: 5px;">
        <input id="account-pass" placeholder="Mot de passe" type="text" required />
        <input id="account-nip" placeholder="NIP" style="width: 20%;" type="text" />
      </div>
      <input id="account-expiry" placeholder="Date d'expiration" type="date" />
      <textarea id="account-note" placeholder="Note"></textarea>
      <input id="account-link" placeholder="Lien (https://...)" type="text" />
      <input accept="image/*" id="account-photo" onchange="previewImage()" type="file" />
      <input id="existing-photo" type="hidden" />
      <img id="image-preview" alt="Aper√ßu de l'image" src="#" style="display:none; max-width:95%; margin-top:10px;" />
      <div class="modal-buttons" style="margin-top: 20px;">
        <button type="submit">üíæ Enregistrer</button>
        <button type="button" onclick="closeAccountModal()">‚ùå Annuler</button>
      </div>
    </form>
  </div>
</div>

  
<script>
/* --------------- Donn√©es / √©tat --------------- */
let vaultData = { users: [], accounts: [] };
let fileHandle = null;
let currentUser = null;
let editingIndex = null;
let cryptoKey = null;
let isLoggedIn = false;

/* --------------- Utilitaires cryptographiques --------------- */
async function hashMasterCode(code) {
  const encoder = new TextEncoder();
  const data = encoder.encode(code);
  const hashBuffer = await crypto.subtle.digest("SHA-256", data);
  return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, "0")).join("");
}

/* Valeur attendue du hash ma√Ætre */
async function recupererHashDecrypte() {
  // Remplacer si vous avez le hash exact du "code ma√Ætre"
  return "97adb0a1f731d74ae248cece0c59026d9a615db4eca7c070dadc91c599891cbc";
}

function getMasterString() {
  return atob("bmV3MjEwMTIw"); // "new210120"
}

async function getCryptoKey(master) {
  const encoder = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey("raw", encoder.encode(master), { name: "PBKDF2" }, false, ["deriveKey"]);
  return crypto.subtle.deriveKey({
    name: "PBKDF2",
    salt: encoder.encode("vault_salt"),
    iterations: 100000,
    hash: "SHA-256"
  }, keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]);
}

/* --------------- File save / load avec fallback --------------- */
async function saveVault() {
  if (!cryptoKey) return;
  const encoder = new TextEncoder();
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const encoded = encoder.encode(JSON.stringify(vaultData));
  const encrypted = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, cryptoKey, encoded);
  const blob = new Blob([iv, encrypted]);

  if (!window.showSaveFilePicker) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "vault_data.enc";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    return;
  }

  try {
    if (!fileHandle) {
      fileHandle = await window.showSaveFilePicker({
        suggestedName: "vault_data.enc",
        types: [{ description: "Encrypted Vault", accept: { "application/octet-stream": [".enc"] } }]
      });
    }
    const writable = await fileHandle.createWritable();
    await writable.write(blob);
    await writable.close();
  } catch (e) {
    console.warn("saveVault error:", e);
  }
}

async function loadVault() {
  try {
    if (!window.showOpenFilePicker) return await loadVaultFromInputFallback();
    const [handle] = await window.showOpenFilePicker();
    fileHandle = handle;
    const file = await fileHandle.getFile();
    const buffer = await file.arrayBuffer();
    const iv = buffer.slice(0, 12);
    const data = buffer.slice(12);
    const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, cryptoKey, data);
    vaultData = JSON.parse(new TextDecoder().decode(decrypted));
    return true;
  } catch (e) {
    console.warn("loadVault error:", e);
    vaultData = { users: [], accounts: [] };
    return false;
  }
}

function loadVaultFromInputFallback() {
  return new Promise(resolve => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.enc,application/octet-stream';
    input.onchange = async (ev) => {
      const f = ev.target.files[0];
      if (!f) { resolve(false); return; }
      const buffer = await f.arrayBuffer();
      const iv = buffer.slice(0, 12);
      const data = buffer.slice(12);
      try {
        const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, cryptoKey, data);
        vaultData = JSON.parse(new TextDecoder().decode(decrypted));
        resolve(true);
      } catch (e) {
        console.warn("loadVaultFromInputFallback decrypt error:", e);
        resolve(false);
      }
    };
    input.click();
  });
}

/* --------------- Helpers UI --------------- */
function safeEl(id) {
  try { return document.getElementById(id) || null; } catch (e) { return null; }
}

function showAlert(message) {
  closeAllWindowsAndModals();
  const alertBox = document.createElement("div");
  alertBox.className = "dynamic-alert";
  alertBox.innerHTML = message;
  alertBox.style.backgroundColor = "#fff";
  alertBox.style.color = "#000";
  alertBox.style.padding = "20px";
  alertBox.style.border = "2px solid #333";
  alertBox.style.borderRadius = "8px";
  alertBox.style.boxShadow = "0 4px 12px rgba(0,0,0,0.3)";
  alertBox.style.zIndex = "21000";
  alertBox.style.maxHeight = "80vh";
  alertBox.style.overflowY = "auto";
  alertBox.style.width = "80%";
  alertBox.style.maxWidth = "600px";
  alertBox.style.fontSize = "16px";
  document.body.appendChild(alertBox);
  function onDocClickClose(e) {
    if (!alertBox.contains(e.target)) {
      alertBox.remove();
      document.removeEventListener('click', onDocClickClose);
    }
  }
  setTimeout(() => document.addEventListener('click', onDocClickClose), 50);
}

function showTimedAlert(message, duration = 3000) {
  showAlert(message);
  setTimeout(() => {
    const last = document.querySelector('.dynamic-alert');
    if (last) last.remove();
  }, duration);
}

function showConfirm(message, onConfirm, onCancel) {
  closeAllWindowsAndModals();
  const alertBox = document.createElement("div");
  alertBox.className = "dynamic-alert";
  alertBox.innerHTML = `
    <div style="text-align:center;">
      <div style="margin-bottom:12px;">${message}</div>
      <div style="margin-top:10px; display:flex; justify-content:center; gap:10px;">
        <button id="confirm-yes">Oui</button>
        <button id="confirm-no">Non</button>
      </div>
    </div>
  `;
  alertBox.style.backgroundColor = "#fff";
  alertBox.style.color = "#000";
  alertBox.style.padding = "20px";
  alertBox.style.border = "2px solid #333";
  alertBox.style.borderRadius = "8px";
  alertBox.style.boxShadow = "0 4px 12px rgba(0,0,0,0.3)";
  alertBox.style.zIndex = "21000";
  alertBox.style.width = "80%";
  alertBox.style.maxWidth = "600px";
  document.body.appendChild(alertBox);
  document.getElementById("confirm-yes").onclick = () => { alertBox.remove(); if (onConfirm) onConfirm(); };
  document.getElementById("confirm-no").onclick = () => { alertBox.remove(); if (onCancel) onCancel(); };
}

function closeAllWindowsAndModals() {
  document.querySelectorAll('.modal').forEach(modal => { modal.classList.add('hidden'); modal.style.display = 'none'; });
  document.querySelectorAll('.dynamic-alert').forEach(el => el.remove());
  const menu = document.getElementById('menuItems');
  if (menu && menu.classList.contains('show')) menu.classList.remove('show');
  const inactivity = document.getElementById('inactivity-modal');
  if (inactivity) { inactivity.classList.add('hidden'); inactivity.style.display = 'none'; }
}

/* --------------- Core : Auth / Register / Login --------------- */
async function register() {
  const loader = document.getElementById("loader");
  const loaderText = document.getElementById("loader-text");
  const fullname = document.getElementById("register-fullname").value.trim();
  const username = document.getElementById("register-username").value.trim();
  const password = document.getElementById("register-password").value;
  const inputCode = document.getElementById("register-mastercode").value;
  const nip = document.getElementById("nip").value.trim();

  if (!fullname || fullname.length < 4 || (fullname.replace(/[^a-zA-Z√Ä-√ø]/g, "").length < 4)) {
    return showTimedAlert("‚ùå Le nom complet doit contenir au moins 4 lettres.");
  }
  if (!username || !password || !inputCode) return showAlert("‚ö†Ô∏è Tous les champs doivent √™tre compl√©t√©s pour continuer.");
  if (username.length < 4) return showTimedAlert("‚ùå Le nom d'utilisateur doit contenir au moins 4 caract√®res.");

  const validPassword = password.length >= 8 && /\d/.test(password) && /[.!@#$%^&*(),?":{}|<>]/.test(password) && /[a-z]/.test(password) && /[A-Z]/.test(password);
  if (!validPassword) return showTimedAlert("‚ö†Ô∏è Le mot de passe saisi ne respecte pas les crit√®res de s√©curit√© requis.");

  const hashUtilisateur = await hashMasterCode(inputCode);
  const hashAttendu = await recupererHashDecrypte();
  if (hashUtilisateur !== hashAttendu) return showTimedAlert("üîê Authentification √©chou√©e : code ma√Ætre non reconnu.");

  if (vaultData.users.length > 0) return showAlert("‚ö†Ô∏è Un compte existe d√©j√†. Connectez-vous ou actualisez la page sans importer de fichier.");

  const newUser = nip ? { username, password, nip, fullname } : { username, password, fullname };
  vaultData.users.push(newUser);

  loader.style.display = "flex";
  loaderText.textContent = "üõ†Ô∏è Cr√©ation du compte en cours...";
  await new Promise(resolve => setTimeout(resolve, 300));
  loaderText.textContent = "üéâ F√©licitations, compte cr√©√© avec succ√®s !";
  await saveVault();
  loader.style.display = "none";
  showLogin();
  viderChamp();
}

function login() {
  const usernameInput = document.getElementById("login-username");
  const passwordInput = document.getElementById("login-password");
  const username = usernameInput.value.trim().toLowerCase();
  const password = passwordInput.value;

  if (!username || !password) return showTimedAlert("Oups ! Nom d‚Äôutilisateur ou mot de passe manquant. Compl√©ter et essayons √† nouveau üòä");

  const user = vaultData.users.find(u => u.username.toLowerCase() === username && u.password === password);
  if (!user) return showTimedAlert("‚ùå Identifiants invalides. Veuillez r√©essayer.");

  const now = new Date();
  vaultData.lastLogin = vaultData.lastLogin || {};
  if (vaultData.lastLogin.current) vaultData.lastLogin.previous = vaultData.lastLogin.current;
  vaultData.lastLogin.current = now.toISOString();
  vaultData.loginHistory = vaultData.loginHistory || [];
  vaultData.loginHistory.push({ login: now.toISOString(), logout: null, device: navigator.userAgent });

  saveVault();
  currentUser = user.username;
  isLoggedIn = true;
  document.getElementById("login-container").classList.add("hidden");
  document.getElementById("app-container").classList.remove("hidden");
  renderAccounts();
  startInactivityTimerUnified();

  const loginInfoDiv = document.getElementById("login-info");
  const formatDate = d => new Date(d).toLocaleString("fr-CA", {
    weekday: "long", year: "numeric", month: "long", day: "numeric",
    hour: "2-digit", minute: "2-digit", second: "2-digit"
  });


  const greetingDiv = document.getElementById("greeting-message");
  const hour = now.getHours();
  let salutation = "";
  if (hour >= 5 && hour < 8) salutation = "Bon matin üåÑ";
  else if (hour >= 8 && hour < 13) salutation = "Bonjour üåû";
  else if (hour >= 13 && hour < 18) salutation = "Bon apr√®s-midi ‚õÖ";
  else if (hour >= 18 && hour < 22) salutation = "Bonsoir üåá";
  else salutation = "Bonne nuit üí§";
  const name = user.fullname?.trim() || currentUser;
  const today = new Date();
  const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  const formattedDate = today.toLocaleDateString('fr-CA', options);
  greetingDiv.textContent = `${salutation}, ${name} en ce ${formattedDate}`;
  viderChamp();
}

function logout() {
  if (isLoggedIn) {
    const now = new Date().toISOString();
    vaultData.lastLogin = vaultData.lastLogin || {};
    vaultData.lastLogin.logout = now;
    vaultData.loginHistory = vaultData.loginHistory || [];
    const lastEntry = vaultData.loginHistory[vaultData.loginHistory.length - 1];
    if (lastEntry && !lastEntry.logout) lastEntry.logout = now;
    saveVault();
    isLoggedIn = false;
    document.getElementById("app-container").classList.add("hidden");
    document.getElementById("login-container").classList.remove("hidden");
    showTimedAlert("‚úîÔ∏è D√©connexion r√©ussie.");
  }
}

/* --------------- Account CRUD --------------- */
document.addEventListener("DOMContentLoaded", () => {
  // --- Liaison preview image (s√©curis√©)
  const accountPhoto = document.getElementById("account-photo");
  if (accountPhoto && !accountPhoto._previewAttached) {
    accountPhoto.addEventListener("change", previewImage);
    accountPhoto._previewAttached = true;
  }

  // --- Navigation par Enter : inputs du login et register
  const formInputs = document.querySelectorAll("#login-container input, #register-container input");
  formInputs.forEach((input, index, arr) => {
    input.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        const next = arr[index + 1];
        if (next) next.focus();
      }
    });
  });

  // --- Liaison du bouton "Ajouter un compte" dans le menu
  const menuAddBtn = document.getElementById("menu-add-account");
  if (menuAddBtn && !menuAddBtn._addedListener) {
    menuAddBtn.addEventListener("click", (e) => {
      e.preventDefault();
      // Ouvre form et ferme le menu
      toggleForm();
    });
    menuAddBtn._addedListener = true;
  }

  // --- S√©curiser l'attachement d'autres listeners utiles (ex: bouton du menu principal)
  const menuButton = document.querySelector(".menu-button");
  if (menuButton && !menuButton._attached) {
    menuButton.addEventListener("click", (e) => {
      e.preventDefault();
      toggleMenu();
    });
    menuButton._attached = true;
  }

  
  // --- Assurer l'input focus sur le premier champ si modal d'ajout est d√©j√† ouvert
  const accountModal = document.getElementById("accountModal");
  if (accountModal && accountModal.style.display === "flex") {
    const first = accountModal.querySelector("input, textarea, button");
    if (first) first.focus();
  }

  // --- Toutes les autres initialisations l√©g√®res qui doivent se produire au chargement
  // Par exemple, s'assurer que l'image preview est cach√©e par d√©faut
  const preview = document.getElementById("image-preview");
  if (preview) { preview.style.display = preview.src && preview.src !== "#" ? "block" : "none"; }

  // --- N'affecte pas le submit du formulaire ici ; laisser un handler unique s√©par√©.
});



// Handler unique et fiable pour l'envoi du formulaire account-form
(function attachSingleAccountFormHandler() {
  const form = document.getElementById("account-form");
  if (!form) return;

  form.addEventListener("submit", async function (e) {
    e.preventDefault();

    // R√©cup√©rer explicitement l'index d'√©dition depuis l'attribut data (si pr√©sent)
    const idxRaw = form.dataset.editingIndex;
    const idx = (typeof idxRaw === "string" && idxRaw !== "") && !isNaN(parseInt(idxRaw, 10))
      ? parseInt(idxRaw, 10)
      : null;

    const nameEl = document.getElementById("account-name");
    const passEl = document.getElementById("account-pass");

    const name = (nameEl?.value || "").trim();
    const pass = (passEl?.value || "");

    // Validation claire et unique
    if (!name || !pass) {
      showTimedAlert("üõë Nom de compte & mot de passe sont requis.");
      return;
    }

    // Construire l'objet compte
    const newAccount = {
      name,
      user: (document.getElementById("account-user")?.value || "").trim(),
      pass,
      nip: (document.getElementById("account-nip")?.value || "").trim(),
      expiry: document.getElementById("account-expiry")?.value || "",
      note: (document.getElementById("account-note")?.value || "").trim(),
      link: (document.getElementById("account-link")?.value || "").trim(),
      photo: document.getElementById("existing-photo")?.value || ""
    };

    // Gestion de la photo (si fournie)
    const photoFile = document.getElementById("account-photo")?.files?.[0];

    const persistAndClose = (photoDataUrl) => {
      if (photoDataUrl) newAccount.photo = photoDataUrl;

      if (idx !== null && vaultData.accounts[idx]) {
        // √©dition
        vaultData.accounts[idx] = newAccount;
      } else {
        // ajout : v√©rifier l'unicit√© du nom (insensible √† la casse)
        const exists = vaultData.accounts.some(acc => (acc.name || "").toLowerCase() === name.toLowerCase());
        if (exists) {
          showTimedAlert(`‚ö†Ô∏è Le nom de compte "${name}" existe d√©j√†.`);
          return;
        }
        vaultData.accounts.push(newAccount);
      }

      // Trier, sauvegarder, rafra√Æchir UI
      vaultData.accounts.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
      saveVault();
      renderAccounts();

      // Reset et fermeture modal
      form.reset();
      delete form.dataset.editingIndex;
      const preview = document.getElementById("image-preview");
      if (preview) { preview.style.display = "none"; preview.src = ""; }
      const existingPhoto = document.getElementById("existing-photo");
      if (existingPhoto) existingPhoto.value = "";
      editingIndex = null;
      closeAccountModal();
    };

    if (photoFile) {
      const reader = new FileReader();
      reader.onload = (ev) => persistAndClose(ev.target.result);
      reader.readAsDataURL(photoFile);
    } else {
      persistAndClose(newAccount.photo);
    }
  });
})();



// ‚úÖ Fix du bouton ‚ò∞ Menu
(function attachMenuToggleHandler() {
  const menuBtn = document.getElementById("menu-toggle");
  const menuItems = document.getElementById("menuItems");

  if (!menuBtn || !menuItems) return;

  menuBtn.addEventListener("click", function (e) {
    e.preventDefault();
    e.stopPropagation();

    const isOpen = menuItems.classList.contains("show");
    if (isOpen) {
      menuItems.classList.remove("show");
      menuItems.style.opacity = "0";
      menuItems.style.display = "none";
    } else {
      menuItems.classList.add("show");
      menuItems.style.opacity = "1";
      menuItems.style.display = "flex";
    }
  });

  // Fermer le menu si clic √† l'ext√©rieur
  document.addEventListener("click", function (e) {
    if (!menuItems.contains(e.target) && !menuBtn.contains(e.target)) {
      menuItems.classList.remove("show");
      menuItems.style.opacity = "0";
      menuItems.style.display = "none";
    }
  });

  // Fermer avec √âchap
  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape") {
      menuItems.classList.remove("show");
      menuItems.style.opacity = "0";
      menuItems.style.display = "none";
      menuBtn.focus();
    }
  });
})();

  
/* Sauvegarde/lecture d'un compte */
function saveAccount(account) {
  if (editingIndex !== null) {
    vaultData.accounts[editingIndex] = account;
    editingIndex = null;
  } else {
    vaultData.accounts.push(account);
  }
  vaultData.accounts.sort((a, b) => {
    const nameA = (a.name || "").toLowerCase();
    const nameB = (b.name || "").toLowerCase();
    return nameA.localeCompare(nameB);
  });
  saveVault();
  renderAccounts();
}

function renderAccounts() {
  const list = document.getElementById("accounts-list");
  const search = (document.getElementById("search")?.value || "").toLowerCase();
  list.innerHTML = "";
  const filteredAccounts = (vaultData.accounts || [])
    .map((acc, index) => ({ acc, index }))
    .filter(({ acc }) =>
      (acc.name || "").toLowerCase().includes(search) ||
      (acc.user || "").toLowerCase().includes(search) ||
      (acc.note || "").toLowerCase().includes(search)
    );
  document.getElementById("account-count").textContent = filteredAccounts.length;
  filteredAccounts.forEach(({ acc, index }) => {
    const div = document.createElement("div");
    div.className = "account";
    const noteFormatted = (acc.note || "").replace(/\n/g, "<br>");
    div.innerHTML = `
      <div style="text-align: center; font-weight: bold; font-size: 25px; color: #333;">
        ${acc.name || ""}
      </div><br>
      <div style="font-size: 18px; word-wrap: break-word; white-space: normal;">
        <u><b>User</b></u>: ${acc.user || ""}<br>
        <u><b>Mot de passe</b></u>: ${acc.pass || ""}<br>
        <u><b>NIP</b></u>: ${acc.nip || ""}<br>
        <u><b>Expiration</b>‚åõ</u>: ${acc.expiry ? formatDate(acc.expiry) : ""}<br>
        <div style="background-color: rgba(0, 123, 255, 0.1);padding: 10px;border-radius: 8px;margin-top: 5px;">
        <u><b>Note</b></u> :<br>${noteFormatted}</div>
        ${acc.link ? `<a href="${acc.link}" target="_blank">${acc.link}</a><br>` : ""}<br>
      </div>
      <div class="imgcrtl">
        ${acc.photo ? `<img src="${acc.photo}" alt="photo">` : `<span style="font-size: 60px;">üñºÔ∏è</span>`}
      </div>
      <div class="actions">
        <button onclick="openAccountModal(true, ${index})">‚öôÔ∏è Modifier</button>
        <button onclick="deleteAccount(${index})">üóëÔ∏è Supprimer</button>
      </div>
    `;
    list.appendChild(div);
  });
}

function editAccount(index) {
  const acc = vaultData.accounts[index];
  document.getElementById("account-name").value = acc.name || "";
  document.getElementById("account-user").value = acc.user || "";
  document.getElementById("account-pass").value = acc.pass || "";
  document.getElementById("account-nip").value = acc.nip || "";
  if (acc.nip) document.getElementById("account-nip").disabled = true;
  document.getElementById("account-expiry").value = acc.expiry || "";
  document.getElementById("account-note").value = acc.note || "";
  document.getElementById("account-link").value = acc.link || "";
  document.getElementById("existing-photo").value = acc.photo || "";
  const preview = document.getElementById("image-preview");
  if (acc.photo && preview) {
    preview.src = acc.photo;
    preview.style.display = "block";
  } else if (preview) {
    preview.src = "#";
    preview.style.display = "none";
  }
  const panel = document.getElementById("form-wrapper");
  const button = document.getElementById("toggle-form-button");
  if (!panel.classList.contains("active")) {
    panel.classList.add("active");
    if (button) button.innerHTML = "‚ùå Fermer le formulaire";
  }
  editingIndex = index;
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function deleteAccount(index) {
  const accountName = vaultData.accounts[index].name;
  showConfirm(
    `ü§î √ätes-vous s√ªr de vouloir supprimer le compte <b>"${accountName}"</b> ?`,
    () => {
      vaultData.accounts.splice(index, 1);
      saveVault();
      renderAccounts();
      showTimedAlert(`‚úîÔ∏è Le compte <b>"${accountName}"</b> a √©t√© supprim√© avec succ√®s.`);
    },
    () => showTimedAlert(`‚ùå Suppression annul√©e.`)
  );
}

/* --------------- UI small helpers --------------- */
function toggleMenu() {
  const menu = document.getElementById("menuItems");
  if (menu) menu.classList.toggle("show");
}



function filtrerParNom(nomCompte) {
  const searchInput = document.getElementById("search");
  if (!searchInput) return;
  searchInput.value = nomCompte;
  renderAccounts(); // Cette fonction doit d√©j√† exister et filtrer selon la valeur du champ #search
}


function previewImage() {
  const input = safeEl("account-photo");
  const preview = safeEl("image-preview");
  if (!input || !preview) return;
  const file = input.files && input.files[0];
  if (!file) { preview.src = "#"; preview.style.display = "none"; return; }
  const reader = new FileReader();
  reader.onload = function (e) { preview.src = e.target.result; preview.style.display = "block"; };
  reader.onerror = function () { preview.src = "#"; preview.style.display = "none"; };
  reader.readAsDataURL(file);
}

function viderChamp() {
  document.querySelectorAll("input").forEach(input => input.value = "");
  document.querySelectorAll("textarea").forEach(textarea => textarea.value = "");
}

function formatDate(dateString) {
  const date = new Date(dateString);
  const options = { day: 'numeric', month: 'long', year: 'numeric' };
  return date.toLocaleDateString('fr-FR', options);
}

/* --------------- Inactivity timer unifi√© --------------- */
(function setupInactivityLogic() {
  const WARNING_DELAY_MS = 30 * 1000;    // afficher l'avertissement apr√®s 30s
  const MAX_INACTIVITY_MS = 120 * 1000;  // d√©connecter apr√®s 120s

  let lastInteraction = Date.now();
  let warningShown = false;
  let inactivityIntervalId = null;

  function updateLastInteraction() {
    lastInteraction = Date.now();
    if (warningShown) {
      const modal = document.getElementById("inactivity-modal");
      if (modal) {
        modal.classList.add("hidden");
        modal.style.display = "none";
      }
      warningShown = false;
    }
  }

  function tick() {
    if (!isLoggedIn) return;
    const elapsed = Date.now() - lastInteraction;

    if (elapsed >= WARNING_DELAY_MS && elapsed < MAX_INACTIVITY_MS) {
      if (!warningShown) {
        const modal = document.getElementById("inactivity-modal");
        if (modal) {
          modal.classList.remove("hidden");
          modal.style.display = "flex";
        }
        warningShown = true;
      }
      const remaining = Math.max(0, Math.floor((MAX_INACTIVITY_MS - elapsed) / 1000));
      const hours = Math.floor(remaining / 3600);
      const minutes = Math.floor((remaining % 3600) / 60);
      const seconds = remaining % 60;
      const hrsEl = document.getElementById("hours-value");
      const minEl = document.getElementById("minutes-value");
      const secEl = document.getElementById("seconds-value");
      if (hrsEl) hrsEl.textContent = String(hours).padStart(2, '0');
      if (minEl) minEl.textContent = String(minutes).padStart(2, '0');
      if (secEl) secEl.textContent = String(seconds).padStart(2, '0');
      const ph = document.getElementById("progress-hours");
      const pm = document.getElementById("progress-minutes");
      const ps = document.getElementById("progress-seconds");
      if (ph) ph.style.strokeDashoffset = 282.6 * (1 - (hours / Math.max(1, hours)));
      if (pm) pm.style.strokeDashoffset = 282.6 * (1 - (minutes / 60));
      if (ps) ps.style.strokeDashoffset = 282.6 * (1 - (seconds / 60));
    }

    if (elapsed >= MAX_INACTIVITY_MS) {
      clearInterval(inactivityIntervalId);
      inactivityIntervalId = null;
      const modal = document.getElementById("inactivity-modal");
      if (modal) { modal.classList.add("hidden"); modal.style.display = 'none'; }
      warningShown = false;
      logout();
      showAlert("‚è±Ô∏è Vous √©tiez d√©connect√© apr√®s 2 minutes d'inactivit√©.");
    }
  }

  function start() {
    if (inactivityIntervalId) clearInterval(inactivityIntervalId);
    lastInteraction = Date.now();
    warningShown = false;
    const modal = document.getElementById("inactivity-modal");
    if (modal) { modal.classList.add("hidden"); modal.style.display = "none"; }
    inactivityIntervalId = setInterval(tick, 1000);
  }

  // Exposer contr√¥les publics
  window.startInactivityTimerUnified = function() {
    if (!isLoggedIn) return;
    start();
  };
  window.resetInactivityTimerUnified = function() {
    if (!isLoggedIn) return;
    updateLastInteraction();
  };

  // √âv√©nements globaux
  ['click', 'mousemove', 'keydown', 'scroll', 'touchstart'].forEach(evt => {
    document.addEventListener(evt, () => {
      if (isLoggedIn) updateLastInteraction();
    }, { passive: true });
  });

  // Cliquer sur la modal arr√™te le d√©compte
  document.addEventListener('click', (e) => {
    const modal = document.getElementById('inactivity-modal');
    if (!modal) return;
    if (!modal.classList.contains('hidden') && modal.contains(e.target)) {
      updateLastInteraction();
    }
  });
})();

/* --------------- Historique & affichages --------------- */
function afficherDerniereConnexion() {
  const user = vaultData.users.find(u => u.username === currentUser);
  const topButtons = [];
  if (!user?.fullname) topButtons.push(`<button onclick="openFullnameModal()" style="background:#007bff;color:white;padding:8px 14px;border:none;border-radius:6px;cursor:pointer;margin:6px;font-weight:bold;">üßæ Nom du d√©tenteur du compte</button>`);
  if (!user?.nip) topButtons.push(`<button onclick="openNipCreation()" style="background:#cc0000;color:white;padding:8px 14px;border:none;border-radius:6px;cursor:pointer;margin:6px;font-weight:bold;">üîê Cr√©er un NIP</button>`);
  if (user?.nip) topButtons.push(`<button onclick="openNipUpdateModal()" style="background:#ff9800;color:white;padding:8px 14px;border:none;border-radius:6px;cursor:pointer;margin:6px;font-weight:bold;">üîÅ Modifier le NIP</button>`);
  topButtons.push(`<button onclick="toggleFormulaireModification()" style="background:#4285f4;color:white;padding:8px 14px;border:none;border-radius:6px;cursor:pointer;margin:6px;font-weight:bold;">‚öôÔ∏è Modifier ID du compte</button>`);
  const buttonsHtml = `<div style="display:flex;justify-content:center;align-items:center;flex-wrap:wrap;margin:12px 0;">${topButtons.join("")}</div>`;

  const jours = ["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"];
  const mois = ["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];
  let message = `<div style="width:100%;box-sizing:border-box;">${buttonsHtml}<table style="text-align:left;width:100%;border-collapse:collapse;">`;
  const previous = vaultData.lastLogin?.previous ? new Date(vaultData.lastLogin.previous) : null;
  const logoutDate = vaultData.lastLogin?.logout ? new Date(vaultData.lastLogin.logout) : null;
  let infoTexte = `
  <h3 style="font-size:20px;margin:0 0 10px 0;">
    <strong>üïí <u>Historique de connexion</u></strong>
  </h3>
  <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;">
    Votre derni√®re session date du<br>
  </div>`;

  if (previous) {
    const jour = jours[previous.getDay()], jourNum = previous.getDate(), moisNom = mois[previous.getMonth()], annee = previous.getFullYear(), heure = previous.toLocaleTimeString("fr-CA", { hour12: false });
    infoTexte += `üü¢ ${jour} ${jourNum} ${moisNom} ${annee} √† ${heure} <br>`;
  }
  if (logoutDate) {
    const jour = jours[logoutDate.getDay()], jourNum = logoutDate.getDate(), moisNom = mois[logoutDate.getMonth()], annee = logoutDate.getFullYear(), heure = logoutDate.toLocaleTimeString("fr-CA", { hour12: false });
    infoTexte += `üî¥ ${jour} ${jourNum} ${moisNom} ${annee} √† ${heure}. `;
  }
  if (!infoTexte) infoTexte = "üí° Aucune connexion pr√©c√©dente enregistr√©e.";
  
  message += `<tr><td colspan="2"><div style="padding:8px 12px;background-color:#fff3cd;border-radius:6px;text-align:center;"> ${infoTexte} <br><div style="display:flex;justify-content:center;align-items:center;margin-top:8px;">
  <button onclick="afficherHistoriqueConnexion()" style="color:white;background-color:#007bff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;">
    üìú Voir l'historique complet
  </button>
</div>
</div><br></td></tr>`;
  const lastMod = vaultData.lastModification;
  const lastModHtml = lastMod ? (() => {
    const modifDate = new Date(lastMod.date);
    const modifJour = jours[modifDate.getDay()], modifJourNum = modifDate.getDate(), modifMois = mois[modifDate.getMonth()], modifAnnee = modifDate.getFullYear(), modifHeure = modifDate.toLocaleTimeString("fr-CA", { hour12: false });
    return `<tr><td colspan="2">
      <div style="padding:8px 12px;background-color:#e6f0ff;border-radius:6px;text-align:center;">
        <h3 style="font-size:20px;margin:0 0 10px 0;"><strong><u>‚öôÔ∏è Gestion des mots de passe</u></strong></h3>
        <div style="margin-bottom:6px;"><strong>User :</strong> <span>${lastMod.user || ""}</span></div>
        <div style="margin-bottom:6px;">
          <strong>Mot de passe :</strong> <span id="masked-password"> *****</span><br>
          <div style="display:flex;flex-direction:column;align-items:center;margin-top:10px;">
            <input type="password" id="nip-verification" placeholder="NIP requise pour afficher le üîì" style="padding:6px 10px;height:34px;font-size:14px;border-radius:4px;border:1px solid #ccc;width:75%;text-align:center;margin-bottom:8px;">
            <div style="display:flex; gap:8px; justify-content:center; width:100%; box-sizing:border-box;">
              <button onclick="validerNipAffichage()" style="color:white;background-color:#4CAF50;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;">Valider</button>
            </div>
          </div>
        </div>
        <div><strong>Dat. Mod. :</strong> <span>${modifJour} ${modifJourNum} ${modifMois} ${modifAnnee} √† ${modifHeure}</span></div>
      </div><br></td></tr>`;
  })() : `<tr><td colspan="2"><div style="padding:8px 12px;background-color:#f0f4ff;border-radius:6px;text-align:center;">Aucune modification enregistr√©e.</div><br></td></tr>`;
  message += lastModHtml;
  message += `<tr><td colspan="2">
    <div style="display:flex;justify-content:center;margin-top:12px;">
      <button onclick="openReinitConfirm()" style="background:#cc0000;color:white;padding:10px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">üßπ Supprimer le compte</button>
    </div>
  </td></tr>`;
  message += `</table></div>`;
  toggleMenu();
  showAlert(message);
}


function afficherHistoriqueConnexion() {
  closeAllWindowsAndModals();
  const modal = document.getElementById("historiqueConnexionModal");
  const content = document.getElementById("historique-connexion-content");
  const formatDateStr = d => new Date(d).toLocaleString("fr-CA", {
    weekday: "long", year: "numeric", month: "long", day: "numeric",
    hour: "2-digit", minute: "2-digit", second: "2-digit"
  });
  const history = (vaultData.loginHistory || []).slice().reverse();
  let html = `<div style="max-height: 70vh; overflow-y: auto;">`;
  if (history.length === 0) html += `<p style="text-align:center; padding:12px 8px;">üí° Aucune entr√©e d'historique disponible.</p>`;
  else {
    html += `<table><thead><tr><th style="width:33%;">üü¢ Connexion</th><th style="width:33%;">üî¥ D√©connexion</th><th style="width:34%;">üíª Appareil</th></tr></thead><tbody>`;
    history.forEach(entry => {
      const login = entry.login ? formatDateStr(entry.login) : "‚Äî";
      const logout = entry.logout ? formatDateStr(entry.logout) : "‚Äî";
      const device = entry.device || "‚Äî";
      html += `<tr><td>${login}</td><td>${logout}</td><td style="word-break:break-word;">${device}</td></tr>`;
    });
    html += `</tbody></table>`;
  }
  html += `</div>`;
  content.innerHTML = html;
  if (modal) { modal.classList.remove("hidden"); modal.style.display = "flex"; modal.style.zIndex = 20000; const inner = modal.querySelector('.modal-content'); if (inner) inner.style.zIndex = 20001; }
  function onOutsideClick(e) { if (e.target === modal) { modal.classList.add('hidden'); modal.style.display = 'none'; modal.removeEventListener('click', onOutsideClick); } }
  modal.removeEventListener('click', onOutsideClick);
  modal.addEventListener('click', onOutsideClick);
}

/* --------------- R√©cup√©ration / r√©initialisation --------------- */
function showRecovery() {
  document.getElementById("login-container").classList.add("hidden");
  document.getElementById("recovery-container").classList.remove("hidden");
  document.getElementById("recovery-type").value = "";
  viderChamp();
}



  function isBioFacSupported() {
  return window.PublicKeyCredential !== undefined;
}

  window.addEventListener("DOMContentLoaded", () => {
  if (isBioFacSupported()) {
    document.getElementById("bioFacLoginBtn")?.classList.remove("hidden");
    document.getElementById("bioFacToggleBtn")?.classList.remove("hidden");
  }
});

  function getDeviceFingerprint() {
  return btoa(navigator.userAgent + screen.width + screen.height + navigator.language);
}

  function toggleBioFac() {
  const fingerprint = getDeviceFingerprint();
  let savedDevices = JSON.parse(localStorage.getItem("sava.data") || "[]");

  const existing = savedDevices.find(d => d.fingerprint === fingerprint);
  if (existing) {
    savedDevices = savedDevices.filter(d => d.fingerprint !== fingerprint);
    localStorage.setItem("sava.data", JSON.stringify(savedDevices));
    showAlert("Appareil d√©sactiv√© pour bio/fac.");
    document.getElementById("bioFacToggleBtn").innerText = "‚öôÔ∏è Activer bio/fac";
    return;
  }

  const publicKeyOptions = {
    challenge: new Uint8Array(32),
    rp: { name: "Gestions üîê" },
    user: {
      id: new Uint8Array(16),
      name: currentUser?.username || "utilisateur",
      displayName: currentUser?.fullname || currentUser?.username || "Compte"
    },
    pubKeyCredParams: [{ type: "public-key", alg: -7 }],
    authenticatorSelection: { authenticatorAttachment: "platform", userVerification: "required" },
    timeout: 60000,
    attestation: "none"
  };

  navigator.credentials.create({ publicKey: publicKeyOptions })
    .then(cred => {
      savedDevices.push({ fingerprint, username: currentUser.username, publicKeyOptions });
      localStorage.setItem("sava.data", JSON.stringify(savedDevices));
      showAlert("Appareil activ√© pour bio/fac.");
      document.getElementById("bioFacToggleBtn").innerText = "‚öôÔ∏è D√©sactiver bio/fac";
    })
    .catch(() => {
      showAlert("Impossible d'activer bio/fac sur cet appareil.");
    });
}


  function tryBioFacLogin() {
  const savedDevices = JSON.parse(localStorage.getItem("sava.data") || "[]");
  if (!savedDevices.length) {
    showAlert("Veuillez ajouter votre appareil en vous connectant, puis cliquer sur 'Activer bio/fac' dans le menu.");
    return;
  }

  if (!vaultData || !vaultData.users) {
    showAlert("Importez d'abord votre fichier s√©curis√© avant d'utiliser la connexion bio/fac.");
    return;
  }

  const fingerprint = getDeviceFingerprint();
  const match = savedDevices.find(d => d.fingerprint === fingerprint);
  if (!match) {
    showAlert("Appareil non reconnu. Veuillez l'ajouter via le menu.");
    return;
  }

  navigator.credentials.get({ publicKey: match.publicKeyOptions })
    .then(() => {
      loginWithBioFac(match.username);
    })
    .catch(() => {
      showAlert("√âchec de l'authentification biom√©trique.");
    });
}


  function loginWithBioFac(username) {
  const user = vaultData.users.find(u => u.username === username);
  if (!user) {
    showAlert("Utilisateur introuvable dans le fichier import√©.");
    return;
  }
  currentUser = user;
  isLoggedIn = true;
  showApp();
}

async function recoverIdentity() {
  const type = document.getElementById("recovery-type").value;
  const known = document.getElementById("recovery-known").value.trim();
  const nip = document.getElementById("recovery-mastercode").value;
  if (!type || !known || !nip) return showTimedAlert("‚ö†Ô∏è Tous les champs doivent √™tre remplis.");
  const user = vaultData.users.find(u =>
    (type === "username" && u.password === known && u.nip === nip) ||
    (type === "password" && u.username === known && u.nip === nip)
  );
  if (!user) return showTimedAlert("‚ùå Aucun utilisateur correspondant trouv√© ou NIP incorrect.");
  showAlert(`
    <h2>üîß Modifier ${type === "username" ? "le nom d'utilisateur" : "le mot de passe"}</h2>
    <input style="display: block; margin: 0 auto;" type="text" id="new-value" placeholder="Nouveau ${type === "username" ? "nom d'utilisateur" : "mot de passe"}">
    ${type === "password" ? `
      <div id="password-requirements-container-recovery" style="text-align: center;">
        <ul id="password-requirements-recovery" style="display: inline-block; font-size: 14px; list-style: none; text-align: left;">
          <li id="req-length-recovery">‚ùå Au moins 8 caract√®res</li>
          <li id="req-digit-recovery">‚ùå Inclure un chiffre</li>
          <li id="req-special-recovery">‚ùå Inclure un caract√®re sp√©cial</li>
          <li id="req-lowercase-recovery">‚ùå Inclure une lettre minuscule</li>
          <li id="req-uppercase-recovery">‚ùå Inclure une lettre majuscule</li>
        </ul>
      </div><br>
    ` : ""}
    <br><button style="display: block; margin: 0 auto;" onclick="applyRecovery('${type}', '${user.username}')">Mettre √† jour</button>
  `);
  if (type === "password") {
    document.addEventListener("input", function (e) {
      if (e.target.id === "new-value") {
        const value = e.target.value;
        const set = (id, ok, text) => { const el = document.getElementById(id); if (el) el.textContent = (ok ? "‚úîÔ∏è " : "‚ùå ") + text; };
        set("req-length-recovery", value.length >= 8, "Au moins 8 caract√®res");
        set("req-digit-recovery", /\d/.test(value), "Inclure un chiffre");
        set("req-special-recovery", /[.!@#$%^&*(),?\":{}|<>]/.test(value), "Inclure un caract√®re sp√©cial");
        set("req-lowercase-recovery", /[a-z]/.test(value), "Inclure une lettre minuscule");
        set("req-uppercase-recovery", /[A-Z]/.test(value), "Inclure une lettre majuscule");
      }
    });
  }
}


function openAccountModal(isEdit = false, index = null) {
  const modal = safeEl("accountModal");
  const title = safeEl("accountModalTitle");

  // stocker l'index d'√©dition dans l'attribut du formulaire (utile et fiable)
  const form = safeEl("account-form");
  if (form) {
    form.dataset.editingIndex = (isEdit && index !== null) ? String(index) : "";
  }
  safeEl("account-form").dataset.editingIndex = String(index);

  editingIndex = isEdit ? index : null;

  if (isEdit && vaultData.accounts[index]) {
    const acc = vaultData.accounts[index];
    safeEl("account-name").value = acc.name || "";
    safeEl("account-user").value = acc.user || "";
    safeEl("account-pass").value = acc.pass || "";
    safeEl("account-nip").value = acc.nip || "";
    if (acc.nip) safeEl("account-nip").disabled = true;
    safeEl("account-expiry").value = acc.expiry || "";
    safeEl("account-note").value = acc.note || "";
    safeEl("account-link").value = acc.link || "";
    safeEl("existing-photo").value = acc.photo || "";
    safeEl("image-preview").src = acc.photo || "#";
    safeEl("image-preview").style.display = acc.photo ? "block" : "none";
    title.textContent = "‚öôÔ∏è Modifier un compte";
  } else {
    if (form) form.reset();
    safeEl("image-preview").style.display = "none";
    safeEl("existing-photo").value = "";
    title.textContent = "üìù Ajouter un compte";
  }

  if (modal) {
    modal.classList.remove("hidden");
    modal.style.display = "flex";
    const first = modal.querySelector("input, textarea, button");
    if (first) first.focus();
  }
}

  

function closeAccountModal() {
  const modal = safeEl("accountModal");
  if (modal) {
    modal.classList.add("hidden");
    modal.style.display = "none";
  }
  // R√©initialiser le formulaire et l'aper√ßu
  const form = safeEl("account-form");
  if (form) form.reset();
  const preview = safeEl("image-preview");
  if (preview) { preview.style.display = "none"; preview.src = ""; }
  const existing = safeEl("existing-photo");
  if (existing) existing.value = "";
  editingIndex = null;
}



  
function applyRecovery(type, username) {
  const newValue = (document.getElementById("new-value")?.value || "").trim();
  if (!newValue) return showTimedAlert("üí° Veuillez entrer une nouvelle valeur.");
  if (type === "username") {
    if (newValue.length < 4) return showTimedAlert("‚ùå Le nom d'utilisateur doit contenir au moins 4 caract√®res.");
  } else {
    const validPassword = newValue.length >= 8 && /\d/.test(newValue) && /[.!@#$%^&*(),?":{}|<>]/.test(newValue) && /[a-z]/.test(newValue) && /[A-Z]/.test(newValue);
    if (!validPassword) return showTimedAlert("‚ö†Ô∏è Le mot de passe ne respecte pas les crit√®res de s√©curit√©.");
  }
  if (!vaultData || !Array.isArray(vaultData.users)) return showTimedAlert("‚ö†Ô∏è Les donn√©es utilisateur ne sont pas disponibles. Veuillez importer le fichier vault_data.");
  const user = vaultData.users.find(u => u.username === username);
  if (!user) return showTimedAlert("‚ùå Utilisateur introuvable. Assurez-vous d'avoir import√© le fichier vault_data.");
  if (type === "username") user.username = newValue; else user.password = newValue;
  currentUser = user.username;
  saveVault();
  showTimedAlert("‚úîÔ∏è Identifiant mis √† jour avec succ√®s !");
  showLogin();
}

/* --------------- NIP unify / Modales NIP --------------- */
function openNipCreation() {
  closeAllWindowsAndModals();
  const modal = document.getElementById("nipModal");
  if (modal) {
    modal.classList.remove("hidden");
    modal.style.display = "flex";
    const nipInput = document.getElementById("nipInput");
    if (nipInput) nipInput.value = "";
  }
}







// Fix robuste pour le bouton ‚ò∞ Menu
(function attachRobustMenuButton() {
  const menuBtn = document.querySelector(".menu-button") || document.getElementById("menu-toggle");
  const menuItems = document.getElementById("menuItems");
  const menuContainer = document.getElementById("menuContainer");

  if (!menuBtn || !menuItems || !menuContainer) {
    // √©l√©ments manquants ‚Äî rien √† faire
    return;
  }

  // Handler unique : toggle propre de la classe "show" et gestion d'accessibilit√©
  function onMenuClick(e) {
    e.stopPropagation();
    e.preventDefault();
    // Fermer toutes les modales/alerts visibles (optionnel, mais utile)
    closeAllWindowsAndModals();

    const wasOpen = menuItems.classList.contains("show");
    // Fermer tout panneau ouvert avant d'ouvrir
    document.querySelectorAll(".menu-items.show").forEach(el => {
      if (el !== menuItems) el.classList.remove("show");
    });

    if (!wasOpen) {
      menuItems.classList.add("show");
      menuItems.style.display = "flex";
      // focus sur le premier bouton pour accessibilit√©
      const first = menuItems.querySelector("button, a, [tabindex]");
      if (first) first.focus();
    } else {
      menuItems.classList.remove("show");
      // laisser le css g√©rer display via .show, mais s'assurer de none pour compatibilit√©
      menuItems.style.display = "";
    }
  }

  // Retirer ancien listener s'il existe (s√©curit√©)
  if (menuBtn._menuHandlerAttached) {
    menuBtn.removeEventListener("click", menuBtn._menuHandlerAttached);
    delete menuBtn._menuHandlerAttached;
  }

  menuBtn.addEventListener("click", onMenuClick);
  menuBtn._menuHandlerAttached = onMenuClick;

  // Fermer le menu si clic √† l'ext√©rieur
  document.addEventListener("click", function (e) {
    if (!menuItems.classList.contains("show")) return;
    if (!menuContainer.contains(e.target) && !menuItems.contains(e.target)) {
      menuItems.classList.remove("show");
      menuItems.style.display = "";
    }
  }, { passive: true });

  // Fermer le menu avec √âchap
  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape" && menuItems.classList.contains("show")) {
      menuItems.classList.remove("show");
      menuItems.style.display = "";
      menuBtn.focus();
    }
  });
})();

  
function afficherHistorique(data) {
  const container = document.getElementById("historique-connexion-content");
  if (!data || data.length === 0) {
    container.innerHTML = "<p>Aucune donn√©e trouv√©e.</p>";
    return;
  }

  const table = document.createElement("table");
  const header = document.createElement("tr");
  header.innerHTML = "<th>Compte</th><th>Date</th><th>IP</th>";
  table.appendChild(header);

  data.forEach(entry => {
    const row = document.createElement("tr");
    row.innerHTML = `<td>${entry.nom || "?"}</td><td>${entry.date}</td><td>${entry.ip || "?"}</td>`;
    table.appendChild(row);
  });

  container.appendChild(table);
}



  // Construire et afficher un calendrier qui n'autorise que les dates pr√©sentes dans vaultData.loginHistory
function buildAvailableDatesCalendar() {
  const container = document.getElementById("calendar-container");
  if (!container) return;
  container.innerHTML = "";

  // Extraire jours uniques depuis vaultData.loginHistory (format YYYY-MM-DD)
  const history = Array.isArray(vaultData.loginHistory) ? vaultData.loginHistory : [];
  const daySet = new Set();
  history.forEach(entry => {
    if (!entry || !entry.login) return;
    const d = new Date(entry.login);
    if (isNaN(d)) return;
    const key = d.toISOString().slice(0,10);
    daySet.add(key);
  });

  if (daySet.size === 0) {
    container.innerHTML = "<div style='text-align:center;color:#666;padding:10px;'>Aucune date d'historique disponible.</div>";
    document.getElementById("periode-affichee").textContent = "";
    return;
  }

  // D√©terminer p√©riode min/max √† afficher (montrer mois entre min et max)
  const days = Array.from(daySet).sort();
  const minDay = new Date(days[0]);
  const maxDay = new Date(days[days.length - 1]);

  // G√©n√©rer interface : navigation par mois
  const state = { year: minDay.getFullYear(), month: minDay.getMonth() };
  // si min et max dans des mois diff√©rents, on commence par min; sinon start same
  const nav = document.createElement("div");
  nav.className = "calendar-controls";
  nav.innerHTML = `
    <button class="calendar-nav-btn" id="cal-prev">&lt;</button>
    <div class="calendar-month-title" id="cal-month-title"></div>
    <button class="calendar-nav-btn" id="cal-next">&gt;</button>
  `;
  container.appendChild(nav);
  const gridWrap = document.createElement("div");
  gridWrap.className = "calendar";
  container.appendChild(gridWrap);

  function renderMonth(year, month) {
    const monthTitle = document.getElementById("cal-month-title");
    const dt = new Date(year, month, 1);
    const title = dt.toLocaleString("fr-CA", { month: "long", year: "numeric" });
    if (monthTitle) monthTitle.textContent = title;

    // Clear previous grid
    gridWrap.innerHTML = `
      <div style="width:100%;max-width:520px;">
        <div class="calendar-grid" id="calendar-grid-weekdays"></div>
        <div class="calendar-grid" id="calendar-grid-days"></div>
      </div>
    `;
    // weekdays header
    const wk = ['Di','Lu','Ma','Me','Je','Ve','Sa'];
    const weekdaysEl = document.getElementById("calendar-grid-weekdays");
    wk.forEach(w => {
      const el = document.createElement("div");
      el.className = "calendar-weekday";
      el.textContent = w;
      weekdaysEl.appendChild(el);
    });

    const daysEl = document.getElementById("calendar-grid-days");
    // first day index
    const firstDayIndex = new Date(year, month, 1).getDay(); // 0..6
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // fill leading blanks
    for (let i=0;i<firstDayIndex;i++) {
      const empty = document.createElement("div");
      empty.className = "calendar-day disabled";
      empty.textContent = "";
      daysEl.appendChild(empty);
    }

    // fill days
    for (let d=1; d<=daysInMonth; d++) {
      const dayDate = new Date(year, month, d);
      const key = dayDate.toISOString().slice(0,10);
      const dayEl = document.createElement("div");
      dayEl.className = "calendar-day";
      dayEl.textContent = String(d);
      if (daySet.has(key)) {
        dayEl.classList.add("available");
        dayEl.tabIndex = 0;
        dayEl.addEventListener("click", () => {
          // deselect prev
          document.querySelectorAll(".calendar-day.selected").forEach(e => e.classList.remove("selected"));
          dayEl.classList.add("selected");
          // afficher p√©riode pour la journ√©e : d√©but = jour 00:00, fin = jour+1 00:00
          const debut = new Date(year, month, d);
          const fin = new Date(debut.getTime() + 24*60*60*1000);
          document.getElementById("periode-affichee").textContent = `üîé Affichage du ${debut.toLocaleDateString()}`;
          afficherHistoriqueFiltreLoginHistory(debut, fin);
        });
      } else {
        dayEl.classList.add("disabled");
      }
      daysEl.appendChild(dayEl);
    }
  }

  // navigation
  function clampToRange(y, m) {
    // clamp month/year to interval [minDay, maxDay]
    const candidate = new Date(y, m, 1);
    if (candidate < new Date(minDay.getFullYear(), minDay.getMonth(), 1)) {
      return { y: minDay.getFullYear(), m: minDay.getMonth() };
    }
    if (candidate > new Date(maxDay.getFullYear(), maxDay.getMonth(), 1)) {
      return { y: maxDay.getFullYear(), m: maxDay.getMonth() };
    }
    return { y: y, m: m };
  }

  document.getElementById("cal-prev")?.addEventListener("click", () => {
    let ny = state.year, nm = state.month - 1;
    if (nm < 0) { nm = 11; ny--; }
    const cl = clampToRange(ny, nm);
    state.year = cl.y; state.month = cl.m;
    renderMonth(state.year, state.month);
  });
  document.getElementById("cal-next")?.addEventListener("click", () => {
    let ny = state.year, nm = state.month + 1;
    if (nm > 11) { nm = 0; ny++; }
    const cl = clampToRange(ny, nm);
    state.year = cl.y; state.month = cl.m;
    renderMonth(state.year, state.month);
  });

  // render initial (start at min month)
  renderMonth(state.year, state.month);

  // Optionnel : s√©lectionner automatiquement la derni√®re date enregistr√©e
  const lastDayKey = Array.from(daySet).sort().pop();
  if (lastDayKey) {
    const last = new Date(lastDayKey);
    // si last in rendered month, trigger click programmatically apr√®s rendu
    if (last.getFullYear() === state.year && last.getMonth() === state.month) {
      setTimeout(() => {
        const days = document.querySelectorAll(".calendar-day.available");

        days.forEach(el => { if (el.textContent === String(last.getDate())) el.click(); });
      }, 60);
    }
  }
}

// appeler buildAvailableDatesCalendar() quand la modal est ouverte
// Modifier afficherHistoriqueConnexion pour appeler le builder apr√®s l'ouverture
(function patchAfficherHistoriqueConnexionToBuildCalendar(){
  const orig = window.afficherHistoriqueConnexion;
  window.afficherHistoriqueConnexion = function() {
    orig(); // ouvre la modal et remplit le contenu
    setTimeout(() => {
      buildAvailableDatesCalendar();
    }, 80);
  };
})();
 
function filtrerHistoriqueParPeriode() {
  const select = document.getElementById("filtre-periode");
  const periode = select.value;
  const affichage = document.getElementById("periode-affichee");
  const maintenant = new Date();
  let debut = null;
  let fin = null; // fin exclusive

  // Par d√©faut : fin = maintenant + 1ms pour inclure "maintenant"
  fin = new Date(maintenant.getTime() + 1);

  switch (periode) {
    case "aujourdhui":
      debut = new Date(maintenant.getFullYear(), maintenant.getMonth(), maintenant.getDate());
      fin = new Date(debut.getTime() + 24 * 60 * 60 * 1000);
      affichage.textContent = `üìÖ Connexions du ${debut.toLocaleDateString()}`;
      break;
    case "hier":
      debut = new Date(maintenant.getFullYear(), maintenant.getMonth(), maintenant.getDate() - 1);
      fin = new Date(debut.getTime() + 24 * 60 * 60 * 1000);
      affichage.textContent = `üìÖ Connexions du ${debut.toLocaleDateString()}`;
      break;
    case "semaine":
      debut = new Date(maintenant.getFullYear(), maintenant.getMonth(), maintenant.getDate() - 7);
      affichage.textContent = `üìÖ Connexions depuis le ${debut.toLocaleDateString()}`;
      break;
    case "1mois":
      debut = new Date(maintenant.getFullYear(), maintenant.getMonth() - 1, maintenant.getDate());
      affichage.textContent = `üìÖ Connexions depuis le ${debut.toLocaleDateString()}`;
      break;
    case "3mois":
      debut = new Date(maintenant.getFullYear(), maintenant.getMonth() - 3, maintenant.getDate());
      affichage.textContent = `üìÖ Connexions depuis le ${debut.toLocaleDateString()}`;
      break;
    case "6mois":
      debut = new Date(maintenant.getFullYear(), maintenant.getMonth() - 6, maintenant.getDate());
      affichage.textContent = `üìÖ Connexions depuis le ${debut.toLocaleDateString()}`;
      break;
    case "1an":
      debut = new Date(maintenant.getFullYear() - 1, maintenant.getMonth(), maintenant.getDate());
      affichage.textContent = `üìÖ Connexions depuis le ${debut.toLocaleDateString()}`;
      break;
    case "tous":
      debut = null;
      fin = null;
      affichage.textContent = `üìÖ Toutes les connexions affich√©es`;
      break;
    default:
      affichage.textContent = "";
      // si aucune p√©riode s√©lectionn√©e, on vide le contenu
      document.getElementById("historique-connexion-content").innerHTML = "";
      return;
  }

  afficherHistoriqueFiltreLoginHistory(debut, fin);
}

function afficherHistoriqueFiltreLoginHistory(debut, fin) {
  const container = document.getElementById("historique-connexion-content");
  container.innerHTML = ""; // reset

  const history = Array.isArray(vaultData.loginHistory) ? vaultData.loginHistory.slice().reverse() : [];

  const filtr√©es = history.filter(entry => {
    if (!entry || !entry.login) return false;
    const d = new Date(entry.login);
    if (!debut && !fin) return true;
    if (debut && fin) return d >= debut && d < fin;
    if (debut && !fin) return d >= debut;
    return true;
  });

  if (filtr√©es.length === 0) {
    container.innerHTML = "<p>Aucune connexion trouv√©e pour cette p√©riode.</p>";
    return;
  }

  // Construire un tableau propre
  const table = document.createElement("table");
  table.style.width = "100%";
  table.style.borderCollapse = "collapse";
  table.innerHTML = `<thead><tr><th style="padding:8px;border-bottom:1px solid #ddd;">üü¢ Connexion</th><th style="padding:8px;border-bottom:1px solid #ddd;">üî¥ D√©connexion</th><th style="padding:8px;border-bottom:1px solid #ddd;">üíª Appareil</th></tr></thead>`;
  const tbody = document.createElement("tbody");

  filtr√©es.forEach(entry => {
    const tr = document.createElement("tr");
    const login = entry.login ? new Date(entry.login).toLocaleString("fr-CA", { weekday: "long", year: "numeric", month: "long", day: "numeric", hour: "2-digit", minute: "2-digit", second: "2-digit" }) : "‚Äî";
    const logout = entry.logout ? new Date(entry.logout).toLocaleString("fr-CA", { hour: "2-digit", minute: "2-digit", second: "2-digit", year: "numeric", month: "long", day: "numeric" }) : "‚Äî";
    const device = entry.device || "‚Äî";
    tr.innerHTML = `<td style="padding:8px;border-bottom:1px solid #f0f0f0;">${login}</td><td style="padding:8px;border-bottom:1px solid #f0f0f0;">${logout}</td><td style="padding:8px;border-bottom:1px solid #f0f0f0;word-break:break-word;">${device}</td>`;
    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  container.appendChild(table);
}


  function afficherHistoriqueFiltr√©(debut, fin) {
  const container = document.getElementById("historique-connexion-content");
  container.innerHTML = ""; // reset

  const connexions = vaultData?.accounts?.filter(acc => acc.dateConnexion); // exemple
  const filtr√©es = connexions.filter(acc => {
    const date = new Date(acc.dateConnexion);
    if (!debut) return true;
    return date >= debut && date < fin;
  });

  if (filtr√©es.length === 0) {
    container.innerHTML = "<p>Aucune connexion trouv√©e pour cette p√©riode.</p>";
    return;
  }

  filtr√©es.forEach(acc => {
    const ligne = document.createElement("div");
    ligne.textContent = `üîê ${acc.nom} ‚Äî ${new Date(acc.dateConnexion).toLocaleString()}`;
    container.appendChild(ligne);
  });
}


// Ouvre la confirmation de suppression adapt√©e √† la p√©riode actuellement affich√©e
function confirmerSuppressionHistorique() {
  // R√©cup√®re la p√©riode affich√©e (si calendrier -> on prend la date affich√©e, sinon null)
  const periodeTexte = (document.getElementById("periode-affichee")?.textContent || "").trim();
  // D√©terminer la p√©riode cible : si le texte contient "Affichage du" on interpr√®te une journ√©e
  let cible = { type: "all", debut: null, fin: null };
  if (periodeTexte.startsWith("üîé Affichage du")) {
    // Ex : "üîé Affichage du 16/10/2025" ou selon locale
    const dateStr = periodeTexte.replace("üîé Affichage du", "").trim();
    const parsed = new Date(dateStr);
    if (!isNaN(parsed)) {
      const debut = new Date(parsed.getFullYear(), parsed.getMonth(), parsed.getDate(), 0, 0, 0, 0);
      const fin = new Date(debut.getTime() + 24 * 60 * 60 * 1000);
      cible = { type: "day", debut, fin };
    } else {
      // tenter format fr-CA si n√©cessaire
      const tryIso = new Date(periodeTexte.replace("üîé Affichage du", "").trim());
      if (!isNaN(tryIso)) {
        const debut = new Date(tryIso.getFullYear(), tryIso.getMonth(), tryIso.getDate(), 0, 0, 0, 0);
        const fin = new Date(debut.getTime() + 24 * 60 * 60 * 1000);
        cible = { type: "day", debut, fin };
      }
    }
  } else if (periodeTexte.includes("Toutes les connexions") || periodeTexte.includes("Toutes")) {
    cible = { type: "all", debut: null, fin: null };
  } else {
    // fallback : si aucune p√©riode s√©lectionn√©e, emp√™cher suppression globale accidentelle
    return showAlert(`<div style="padding:12px;text-align:center;">
      <strong>‚ö†Ô∏è Aucune p√©riode cibl√©e</strong><br/>S√©lectionnez d'abord une date dans le calendrier ou un filtre avant de supprimer.</div>`);
  }

  // Construire la modale de confirmation avec champ NIP
  const modal = document.createElement("div");
  modal.className = "modal";
  modal.style.display = "flex";
  modal.innerHTML = `
    <div class="modal-content" style="max-width:520px;text-align:center;">
      <h3>Confirmer la suppression</h3>
      <p style="margin-top:6px;">
        ${cible.type === "day" ? `Supprimer toutes les connexions du <strong>${cible.debut.toLocaleDateString()}</strong> ?` : `Supprimer <strong>toutes</strong> les connexions enregistr√©es ?`}
      </p>
      <p style="font-size:13px;color:#555;margin-top:6px;">Entrez votre NIP pour confirmer la suppression.</p>
      <input id="nipSuppressionInput" type="password" placeholder="Votre NIP" style="padding:8px 10px;margin-top:8px;width:80%;border-radius:6px;border:1px solid #ccc;">
      <div class="modal-buttons" style="margin-top:14px;">
        <button id="confirmerSuppBtn" style="background:#cc0000;color:white;padding:8px 14px;border:none;border-radius:6px;cursor:pointer;">Valider</button>
        <button id="annulerSuppBtn" style="background:#aaa;color:white;padding:8px 14px;border:none;border-radius:6px;cursor:pointer;">Annuler</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  // Handlers
  document.getElementById("annulerSuppBtn").onclick = () => { modal.remove(); showTimedAlert("‚ùå Suppression annul√©e."); };

  document.getElementById("confirmerSuppBtn").onclick = () => {
    const nip = (document.getElementById("nipSuppressionInput")?.value || "").trim();
    if (!nip || nip.length < 1) {
      return showAlert("<div style='padding:10px;text-align:center;'>‚ùå Veuillez entrer votre NIP.</div>");
    }
    const user = vaultData.users.find(u => u.username === currentUser);
    if (!user) {
      modal.remove();
      return showAlert("<div style='padding:10px;text-align:center;'>‚ùå Utilisateur introuvable.</div>");
    }
    if (!user.nip) {
      modal.remove();
      return showAlert("<div style='padding:10px;text-align:center;'>‚ö†Ô∏è Aucun NIP associ√© √† ce compte. Cr√©ez un NIP avant de pouvoir supprimer.</div>");
    }
    if (nip !== user.nip) {
      return showAlert("<div style='padding:10px;text-align:center;'>‚ùå NIP incorrect. Suppression annul√©e.</div>");
    }

    // Effectuer la suppression sur vaultData.loginHistory selon la cible
    if (!Array.isArray(vaultData.loginHistory)) vaultData.loginHistory = [];

    if (cible.type === "day") {
      const avantCount = vaultData.loginHistory.length;
      vaultData.loginHistory = vaultData.loginHistory.filter(entry => {
        if (!entry || !entry.login) return true; // garder les entr√©es malform√©es par s√©curit√©
        const d = new Date(entry.login);
        return !(d >= cible.debut && d < cible.fin); // garder si en dehors du jour cible
      });
      const supprim√©es = avantCount - vaultData.loginHistory.length;
      // persister
      vaultData.lastModification = { user: currentUser, date: new Date().toISOString(), action: `suppression_jour_${cible.debut.toISOString().slice(0,10)}`, count: supprim√©es };
      saveVault();
      modal.remove();
      // rafra√Æchir l'affichage : reconstruire calendrier + table
      buildAvailableDatesCalendar?.();
      // si modal d'historique est ouverte, re-render du contenu pour la p√©riode actuelle
      document.getElementById("periode-affichee").textContent = `üîé Suppression effectu√©e pour ${cible.debut.toLocaleDateString()}`;
      afficherHistoriqueFiltreLoginHistory(cible.debut, cible.fin);
      showTimedAlert(`‚úîÔ∏è ${supprim√©es} entr√©e(s) supprim√©e(s) pour le ${cible.debut.toLocaleDateString()}.`);
      return;
    } else {
      // suppression globale (rare) ‚Äî demander une confirmation finale
      const ok = confirm("‚ö†Ô∏è Vous allez supprimer toutes les entr√©es d'historique. Confirmez-vous ?");
      if (!ok) { modal.remove(); return showTimedAlert("‚ùå Suppression globale annul√©e."); }
      const count = vaultData.loginHistory.length;
      vaultData.loginHistory = [];
      vaultData.lastModification = { user: currentUser, date: new Date().toISOString(), action: "suppression_historique_complet", count };
      saveVault();
      modal.remove();
      buildAvailableDatesCalendar?.();
      document.getElementById("periode-affichee").textContent = `üîé Aucune entr√©e disponible`;
      document.getElementById("historique-connexion-content").innerHTML = "<p>Aucune connexion trouv√©e pour cette p√©riode.</p>";
      showTimedAlert(`‚úîÔ∏è ${count} entr√©e(s) supprim√©e(s).`);
      return;
    }
  };
}



function toggleForm() {
  // ferme le menu si ouvert
  const menu = document.getElementById("menuItems");
  if (menu && menu.classList.contains("show")) menu.classList.remove("show");

  // affiche le modal d'ajout (non-√©dition)
  openAccountModal(false, null);
}

  
function validerSuppressionHistorique(dateFiltre) {
  const nip = document.getElementById("nipSuppression").value;
  if (!nip || nip.length < 4) {
    showAlert("‚ùå NIP invalide. Veuillez entrer un NIP valide.");
    return;
  }

  const contenu = document.getElementById("historique-connexion-content");
  const lignes = contenu.querySelectorAll("tr");
  let suppression = false;

  lignes.forEach(row => {
    const dateCell = row.querySelector("td");
    if (!dateCell) return;
    const dateTexte = dateCell.textContent.trim();
    if (!dateFiltre || dateTexte.includes(dateFiltre)) {
      row.remove();
      suppression = true;
    }
  });

  if (!currentUser?.nip || currentUser.nip.length < 4) {
  showAlert("‚ö†Ô∏è Ce compte ne poss√®de pas de NIP. Veuillez en cr√©er un avant de pouvoir supprimer.");
  return;
}

  document.querySelector(".modal").remove();
  if (suppression) {
    showAlert(`‚úîÔ∏è Historique ${dateFiltre ? "du " + dateFiltre : "complet"} supprim√© avec succ√®s.`);
  } else {
    showAlert("‚ÑπÔ∏è Aucun historique √† supprimer pour cette date.");
  }
}


function verifierExpiration() {
  closeAllWindowsAndModals();
  const comptes = Array.isArray(vaultData.accounts) ? vaultData.accounts.slice() : [];
  if (comptes.length === 0) {
    return showTimedAlert("üí° Aucun compte enregistr√©.");
  }
  const today = new Date();
  const parseDate = (d) => d ? new Date(d) : null;

  // Interface filtre
  let html = `
    <div style="text-align:left;">
      <h3>üìÖ Gestions de suivi</h3>
      <div style="font-size:14px; color:#555; margin-bottom:10px;">
        Aper√ßu des dates d‚Äôexpiration (plus proches en premier).
        <select id="expiration-filter" style="margin-left:10px; padding:4px;">
          <option value="all">Tous</option>
          <option value="1m">Moins de 1 mois</option>
          <option value="3m">Moins de 3 mois</option>
          <option value="6m">Moins de 6 mois</option>
          <option value="1y">Moins de 1 an</option>
          <option value="expired">Expir√©s</option>
          <option value="none">Non disponible</option>
        </select>
      </div>
      <div id="expiration-table"></div>
      <div style="text-align:center; margin-top:15px;">
        <button onclick="closeAllWindowsAndModals()">Fermer</button>
      </div>
    </div>
  `;

  showAlert(html);

  // Rendu dynamique selon filtre
  document.getElementById("expiration-filter").addEventListener("change", (e) => {
    renderExpirationTable(e.target.value);
  });
  renderExpirationTable("all");

  function renderExpirationTable(filter) {
    let rows = "";
    comptes.forEach(acc => {
      const dt = parseDate(acc.expiry);
      const name = acc.name || "(Sans nom)";
      if (!dt) {
        if (filter !== "none" && filter !== "all") return;
        if (filter === "none" || filter === "all") {
          rows += `<tr><td><a href="#" onclick="filtrerParNom('${name}')">${name}</a></td><td>‚Äî</td><td>Non disponible</td></tr>`;
        }
        return;
      }
      const daysLeft = Math.ceil((dt - today) / (1000*60*60*24));
      let statut = "";
      if (daysLeft < 0) statut = "Expir√©";
      else if (daysLeft <= 30) statut = `Expire dans ${daysLeft} j`;
      else if (daysLeft <= 90) statut = `Expire dans ${daysLeft} j`;
      else if (daysLeft <= 180) statut = `Expire dans ${daysLeft} j`;
      else if (daysLeft <= 365) statut = `Expire dans ${daysLeft} j`;
      else statut = `Valide (${daysLeft} j)`;

      if (filter === "expired" && daysLeft >= 0) return;
      if (filter === "1m" && !(daysLeft >= 0 && daysLeft <= 30)) return;
      if (filter === "3m" && !(daysLeft >= 0 && daysLeft <= 90)) return;
      if (filter === "6m" && !(daysLeft >= 0 && daysLeft <= 180)) return;
      if (filter === "1y" && !(daysLeft >= 0 && daysLeft <= 365)) return;

      rows += `<tr>
        <td><a href="#" onclick="focusAccount('${name}')">${name}</a></td>
        <td>${dt.toLocaleDateString()}</td>
        <td>${statut}</td>
      </tr>`;
    });
    const table = `
      <table style="width:100%; border-collapse:collapse;">
        <thead><tr>
          <th>Compte</th><th>Date d‚Äôexpiration</th><th>Statut</th>
        </tr></thead>
        <tbody>${rows || "<tr><td colspan='3'>Aucun r√©sultat</td></tr>"}</tbody>
      </table>
    `;
    document.getElementById("expiration-table").innerHTML = table;
  }
}

  
function focusAccount(name) {
  const cards = document.querySelectorAll("#accounts-list .account");
  for (let card of cards) {
    if (card.textContent.includes(name)) {
      card.scrollIntoView({ behavior: "smooth", block: "center" });
      card.style.outline = "3px solid #007bff";
      setTimeout(() => card.style.outline = "", 2000);
      break;
    }
  }
}


function fermerHistoriqueConnexion() {
  const modal = document.getElementById("historiqueConnexionModal");
  if (modal) {
    modal.classList.add("hidden");
    modal.style.display = "none";
  }
  // Nettoyage visuel √©ventuel
  const container = document.getElementById("historique-connexion-content");
  if (container) container.innerHTML = "";
  const periode = document.getElementById("periode-affichee");
  if (periode) periode.textContent = "";
}


function checklist_mp(containerId) {
  const el = document.getElementById(containerId);
  if (!el) return;
  const isHidden = (el.style.display === "none" || el.style.display === "");
  el.style.display = isHidden ? "block" : "none";
}


function ouvrirModalReinitialisation() {
  closeAllWindowsAndModals();
  const modal = document.getElementById("nipConfirmModal");
  if (modal) {
    modal.classList.remove("hidden");
    modal.style.display = "flex";
    const input = document.getElementById("nipConfirmInput");
    if (input) input.value = "";
  }
}

  
function fermerModalReinitialisation() {
  const modal = document.getElementById("nipConfirmModal");
  if (modal) {
    modal.classList.add("hidden");
    modal.style.display = "none";
  }
}

  
function validerReinitialisation() {
  const nip = (document.getElementById("nipConfirmInput")?.value || "").trim();
  const user = vaultData.users.find(u => u.username === currentUser);
  if (!user?.nip) return showTimedAlert("‚ö†Ô∏è Aucun NIP associ√©. Veuillez en cr√©er un d‚Äôabord.");
  if (nip !== user.nip) return showTimedAlert("‚ùå NIP incorrect. Suppression annul√©e.");
  const confirmationFinale = confirm("‚ö†Ô∏è √ätes-vous s√ªr de vouloir effacer toutes les donn√©es ? Cette action est irr√©versible.");
  if (!confirmationFinale) {
    fermerModalReinitialisation();
    return showTimedAlert("‚ùå Suppression annul√©e.");
  }
  vaultData = { users: [], accounts: [], lastLogin: {}, lastModification: {} };
  saveVault();
  localStorage.clear();
  sessionStorage.clear();
  logout();
  fermerModalReinitialisation();
  showTimedAlert("üóëÔ∏è Toutes les donn√©es ont √©t√© supprim√©es avec succ√®s.");
}

  
(function patchOpenReinitConfirmFlow(){
  window.openReinitConfirm = function() {
    const user = vaultData.users.find(u => u.username === currentUser);
    if (!user?.nip) return showTimedAlert("‚ö†Ô∏è Impossible de r√©initialiser le fichier: aucun NIP associ√©. Veuillez en cr√©er un d'abord.");
    ouvrirModalReinitialisation();
  };
})();

  

function validateNipModal() {
  const nipValue = document.getElementById("nipInput").value.trim();
  const user = vaultData.users.find(u => u.username === currentUser);
  if (!/^[a-zA-Z]{4,15}$/.test(nipValue)) return showTimedAlert("‚ùå Le NIP saisi ne respecte pas les crit√®res. Entre 4 √† 15 caract√®res [a-z, A-Z] sans espaces.");
  if (user) { user.nip = nipValue; vaultData.lastModification = { user: currentUser, date: new Date().toISOString() }; saveVault(); closeNipModal(); showTimedAlert("‚úîÔ∏è NIP enregistr√© avec succ√®s !"); afficherDerniereConnexion(); }
}

  
function closeNipModal() {
  const modal = document.getElementById("nipModal");
  if (modal) {
    modal.classList.add("hidden");
    modal.style.display = "none";
  }
  afficherDerniereConnexion();
}

  
function openNipUpdateModal() {
  closeAllWindowsAndModals();
  const modal = document.getElementById("nipUpdateModal");
  if (modal) {
    modal.classList.remove("hidden");
    modal.style.display = "flex";
    const oldNip = document.getElementById("oldNipInput");
    const newNip = document.getElementById("newNipInput");
    if (oldNip) oldNip.value = "";
    if (newNip) newNip.value = "";
  }
}

  
function closeNipUpdateModal() {
  const modal = document.getElementById("nipUpdateModal");
  if (modal) {
    modal.classList.add("hidden");
    modal.style.display = "none";
  }
  afficherDerniereConnexion();
}

  
function updateNip() {
  const oldNip = document.getElementById("oldNipInput").value.trim();
  const newNip = document.getElementById("newNipInput").value.trim();
  if (!oldNip || !newNip || newNip.length < 4) {
    return showTimedAlert("‚ùå NIP invalide ou trop court.");
  }
  const user = vaultData.users.find(u => u.username === currentUser);
  if (!user || user.nip !== oldNip) {
    return showTimedAlert("‚ùå Ancien NIP incorrect. Veuillez r√©essayez");
  }
  user.nip = newNip;
  saveVault();
  closeNipUpdateModal();
  showTimedAlert("‚úîÔ∏è NIP mis √† jour avec succ√®s.");
}

  
function toggleFormulaireModification() {
  closeAllWindowsAndModals();
  const modal = document.getElementById('updateAccountModal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
    const u = document.getElementById('update-new-username');
    const p = document.getElementById('update-new-password');
    const n = document.getElementById('update-nip');
    if (u) u.value = '';
    if (p) p.value = '';
    if (n) n.value = '';
    setTimeout(() => { if (u) u.focus(); }, 100);
    const menu = document.getElementById('menuItems');
    if (menu) menu.classList.remove('show');
    scrollToTop();
  } else {
    showTimedAlert('‚ö†Ô∏è Modale de modification introuvable.');
  }
}

  
function submitUpdateAccount() {
  const newUsername = document.getElementById("update-new-username").value.trim();
  const newPassword = document.getElementById("update-new-password").value;
  const nip = document.getElementById("update-nip").value.trim();
  const user = vaultData.users.find(u => u.username === currentUser);
  if (!user || user.nip !== nip) {
    return showTimedAlert("‚ùå NIP incorrect.");}
  if (newUsername) user.username = newUsername;
  if (newPassword) {
    const ok = newPassword.length >= 8 && /\d/.test(newPassword) && /[.!@#$%^&*(),?":{}|<>]/.test(newPassword) && /[a-z]/.test(newPassword) && /[A-Z]/.test(newPassword);
    if (!ok) return showTimedAlert("‚ö†Ô∏è Le nouveau mot de passe ne respecte pas les crit√®res de securit√©, veuillez r√©essayez");
    user.password = newPassword;}
  saveVault();
  closeUpdateAccountModal();
  showTimedAlert("‚úîÔ∏è Compte mis √† jour.");
}

  
function closeUpdateAccountModal() {
  const modal = document.getElementById("updateAccountModal");
  if (modal) modal.classList.add("hidden");
  afficherDerniereConnexion();
}

  
function openReinitConfirm() {
  closeAllWindowsAndModals();
  showConfirm("‚ö†Ô∏è Cette action supprimera TOUTES vos donn√©es enregistr√©es, voulez-vous continuez ?.",
    () => {
      const user = vaultData.users.find(u => u.username === currentUser);
      if (!user?.nip) return showTimedAlert("‚ö†Ô∏è Impossible de r√©initialiser le fichier <br>Aucun NIP associ√© a ce compte, veuillez en cr√©er un d'abord.");
      const nip = prompt("Entrez votre NIP pour confirmer la suppression compl√®te :");
      if (nip !== user.nip) return showTimedAlert("‚ùå NIP incorrect. Suppression annul√©e.");
      const confirmationFinale = confirm("‚ö†Ô∏è √ätes-vous s√ªr de vouloir effacer toutes les donn√©es ? Cette action est irr√©versible.");
      if (!confirmationFinale) return showTimedAlert("‚ùå Suppression annul√©e.");
      vaultData = { users: [], accounts: [], lastLogin: {}, lastModification: {} };
      saveVault();
      localStorage.clear();
      sessionStorage.clear();
      logout();
      showTimedAlert("üóëÔ∏è Toutes les donn√©es ont √©t√© supprim√©es avec succ√®s.");
    },
    () => showTimedAlert("‚ùå Suppression annul√©e.")
  );
}

  
function validerNipAffichage() {
  const nipEntr√© = document.getElementById("nip-verification").value.trim();
  const user = vaultData.users.find(u => u.username === currentUser);
  if (user?.nip === nipEntr√©) {
    document.getElementById("masked-password").textContent = user.password || "inconnu";
  } else showTimedAlert("‚ùå NIP incorrect, v√©rifiez le NIP ou r√©essayez.");
}

  
async function importEncryptedVault() {
  const loader = document.getElementById("loader");
  const loaderText = document.getElementById("loader-text");
  try {
    loader.style.display = "flex";
    loaderText.textContent = "‚åõ Chargement en cours...";
    const masterString = getMasterString();
    cryptoKey = await getCryptoKey(masterString);
    const vaultLoaded = await loadVault();
    if (vaultLoaded) {
      loaderText.textContent = "‚úîÔ∏è Chargement termin√©.";
      sessionStorage.setItem("vaultImported", "true");
      renderAccounts();
      await new Promise(resolve => setTimeout(resolve, 300));
    } else {
      loaderText.textContent = "‚ùå √âchec du chargement, v√©rifiez le fichier ou r√©essayez.";
      await new Promise(resolve => setTimeout(resolve, 300));
    }
  } catch (e) {
    loaderText.textContent = `‚ö†Ô∏è Erreur : ${e.message}. V√©rifiez le fichier ou r√©essayez.`;
    console.error("Erreur d√©tect√©e :", e);
    await new Promise(resolve => setTimeout(resolve, 400));
  } finally {
    loader.style.display = "none";
  }
}

  
function openFullnameModal() {
  closeAllWindowsAndModals();
  const modal = document.getElementById("fullnameModal");
  if (modal) modal.classList.remove("hidden");
}

  
function closeFullnameModal() {
  const modal = document.getElementById("fullnameModal");
  if (modal) modal.classList.add("hidden");
  document.getElementById("fullnameInput").value = "";
  afficherDerniereConnexion();
}

  
function validateFullname() {
  const name = document.getElementById("fullnameInput").value.trim();
  if (name.length < 4 || name.replace(/[^a-zA-Z√Ä-√ø]/g, "").length < 4) {
    return showTimedAlert("‚ùå Le nom doit contenir au moins 4 lettres.");
  }
  const user = vaultData.users.find(u => u.username === currentUser);
  if (!user) return showTimedAlert("‚ùå Utilisateur introuvable.");
  user.fullname = name;
  saveVault();
  closeFullnameModal();
  showTimedAlert("‚úîÔ∏è Nom de compte a √©t√© enregistr√© avec succ√®s !");
  afficherDerniereConnexion();
}

  
function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

  
(function ensureChecklistListeners() {
  function attach() {
    const registerPasswordInput = document.getElementById("register-password");
    if (registerPasswordInput && !registerPasswordInput._attachedChecklist) {
      registerPasswordInput.addEventListener("input", function () {
        const value = this.value || "";
        const set = (id, cond, text) => { const el = document.getElementById(id); if (el) el.textContent = (cond ? "‚úîÔ∏è " : "‚ùå ") + text; };
        set("req-length-register", value.length >= 8, "Au moins 8 caract√®res");
        set("req-digit-register", /\d/.test(value), "Inclure un chiffre");
        set("req-special-register", /[.!@#$%^&*(),?\":{}|<>]/.test(value), "Inclure un caract√®re sp√©cial (Ex: .!@#$%^&*(),?:{}|<>)");
        set("req-lowercase-register", /[a-z]/.test(value), "Inclure une lettre minuscule");
        set("req-uppercase-register", /[A-Z]/.test(value), "Inclure une lettre majuscule");
      });
      registerPasswordInput._attachedChecklist = true;}
    const updatePasswordInput = document.getElementById("update-new-password");
    if (updatePasswordInput && !updatePasswordInput._attachedChecklist) {
      updatePasswordInput.addEventListener("input", function () {
        const value = this.value || "";
        const set = (id, cond, text) => { const el = document.getElementById(id); if (el) el.textContent = (cond ? "‚úîÔ∏è " : "‚ùå ") + text; };
        set("req-length-modal", value.length >= 8, "Au moins 8 caract√®res");
        set("req-digit-modal", /\d/.test(value), "Inclure un chiffre");
        set("req-special-modal", /[.!@#$%^&*(),?\":{}|<>]/.test(value), "Inclure un caract√®re sp√©cial");
        set("req-lowercase-modal", /[a-z]/.test(value), "Inclure une lettre minuscule");
        set("req-uppercase-modal", /[A-Z]/.test(value), "Inclure une lettre majuscule");
      });
      updatePasswordInput._attachedChecklist = true;
    }}
  attach();
  const retryId = setInterval(() => {
    attach();
    const r = document.getElementById("register-password") && document.getElementById("update-new-password");
    if (r) { clearInterval(retryId); }
  }, 150);
})();

  
(function attachGlobalClickHandlers() {
  function onDocClick(e) {
    const menu = document.getElementById("menuItems");
    const container = document.getElementById("menuContainer");
    if (!menu || !container) return;
    if (menu.classList.contains("show") && !menu.contains(e.target) && !container.contains(e.target)) {
      menu.classList.remove("show");
    }}
  document.addEventListener("click", onDocClick, { passive: true });
  document.addEventListener("click", function (e) {
    document.querySelectorAll('.modal').forEach(modal => {
      if (!modal.classList.contains('hidden') && e.target === modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
      }});
  }, { passive: true });
})();

  
document.addEventListener("visibilitychange", function () {
  if (document.visibilityState === "visible" && isLoggedIn) {
    window.resetInactivityTimerUnified?.();
}});

  
window.addEventListener("beforeunload", () => {
  if (isLoggedIn && vaultData && vaultData.lastLogin) {
    logout();
    vaultData.lastLogin.logout = new Date().toISOString();
    try { saveVault(); } catch (e) { console.warn("beforeunload saveVault error:", e); }
}});

  
window.toggleForm = toggleForm;
window.toggleMenu = toggleMenu;
window.showRegister = function() { document.getElementById("login-container").classList.add("hidden"); document.getElementById("register-container").classList.remove("hidden"); viderChamp(); };
window.showLogin = function() { document.getElementById("register-container").classList.add("hidden"); document.getElementById("recovery-container").classList.add("hidden"); document.getElementById("login-container").classList.remove("hidden"); viderChamp(); };
window.importEncryptedVault = importEncryptedVault;
window.register = register;
window.login = login;
window.logout = logout;
window.previewImage = previewImage;
window.cancelEdit = cancelEdit;
window.afficherDerniereConnexion = afficherDerniereConnexion;
window.afficherHistoriqueConnexion = afficherHistoriqueConnexion;
window.closeUpdateAccountModal = closeUpdateAccountModal;
window.submitUpdateAccount = submitUpdateAccount;
window.openNipUpdateModal = openNipUpdateModal;
window.closeNipUpdateModal = closeNipUpdateModal;
window.updateNip = updateNip;
window.openNipCreation = openNipCreation;
window.validateNipModal = validateNipModal;
window.closeNipModal = closeNipModal;
window.openReinitConfirm = openReinitConfirm;
window.validateFullname = validateFullname;
window.openFullnameModal = openFullnameModal;
window.closeFullnameModal = closeFullnameModal;

  
//2510191250üîê
</script>

<div style='margin-top:20px;'>
    <button id='activateBio' style='padding:10px;background:#4CAF50;color:white;border:none;border-radius:5px;'>Activer biom√©trie üîê</button>
    <button id='bioLogin' style='padding:10px;background:#2196F3;color:white;border:none;border-radius:5px;display:none;'>Connexion biom√©trique üîë</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const vaultKey = 'vault.data';
    const activateBtn = document.querySelector('#activateBio');
    const bioLoginBtn = document.querySelector('#bioLogin');

    let vaultData = JSON.parse(localStorage.getItem(vaultKey)) || {};

    if (vaultData.bio === true) {
        bioLoginBtn.style.display = 'inline-block';
    }

    activateBtn.addEventListener('click', async () => {
        try {
            const publicKey = {
                challenge: new Uint8Array(32),
                rp: { name: "Secure Login" },
                user: {
                    id: new Uint8Array(16),
                    name: "user@example.com",
                    displayName: "Utilisateur"
                },
                pubKeyCredParams: [{ type: "public-key", alg: -7 }],
                authenticatorSelection: { userVerification: "required" },
                timeout: 60000
            };

            const credential = await navigator.credentials.create({ publicKey });
            vaultData.bio = true;
            vaultData.credentialId = btoa(String.fromCharCode(...new Uint8Array(credential.rawId)));
            localStorage.setItem(vaultKey, JSON.stringify(vaultData));
            alert('Biom√©trie activ√©e ‚úÖ');
            bioLoginBtn.style.display = 'inline-block';
        } catch (err) {
            alert('Erreur activation biom√©trie : ' + err);
        }
    });

    bioLoginBtn.addEventListener('click', async () => {
        try {
            const publicKey = {
                challenge: new Uint8Array(32),
                allowCredentials: [{
                    type: "public-key",
                    id: Uint8Array.from(atob(vaultData.credentialId), c => c.charCodeAt(0))
                }],
                userVerification: "required",
                timeout: 60000
            };

            const assertion = await navigator.credentials.get({ publicKey });
            alert('Connexion biom√©trique r√©ussie üîê');
        } catch (err) {
            alert('√âchec authentification biom√©trique ‚ùå : ' + err);
        }
    });
});
</script>
</body>
</html>


